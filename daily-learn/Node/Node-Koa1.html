<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Node.js +Koa2 打造web框架(一) | 城南花已开</title>
    <meta name="generator" content="VuePress 1.8.3">
    <link rel="icon" href="/blog/assets/logo.ico">
    <meta name="description" content="所爱隔山海，城南花已开">
    
    <link rel="preload" href="/blog/assets/css/0.styles.15804160.css" as="style"><link rel="preload" href="/blog/assets/js/app.2cc39ea3.js" as="script"><link rel="preload" href="/blog/assets/js/2.fb25410d.js" as="script"><link rel="preload" href="/blog/assets/js/33.a282bb1e.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.497e2948.js"><link rel="prefetch" href="/blog/assets/js/11.b4461378.js"><link rel="prefetch" href="/blog/assets/js/12.ed4ac828.js"><link rel="prefetch" href="/blog/assets/js/13.5dd73a9c.js"><link rel="prefetch" href="/blog/assets/js/14.31f9a01b.js"><link rel="prefetch" href="/blog/assets/js/15.9a23c20a.js"><link rel="prefetch" href="/blog/assets/js/16.39eadc81.js"><link rel="prefetch" href="/blog/assets/js/17.254cea96.js"><link rel="prefetch" href="/blog/assets/js/18.23b5d51c.js"><link rel="prefetch" href="/blog/assets/js/19.e1755fff.js"><link rel="prefetch" href="/blog/assets/js/20.9f8568a1.js"><link rel="prefetch" href="/blog/assets/js/21.8a27a340.js"><link rel="prefetch" href="/blog/assets/js/22.f8967a83.js"><link rel="prefetch" href="/blog/assets/js/23.e5122aa7.js"><link rel="prefetch" href="/blog/assets/js/24.a6eab485.js"><link rel="prefetch" href="/blog/assets/js/25.61cd9fb4.js"><link rel="prefetch" href="/blog/assets/js/26.c967bdd1.js"><link rel="prefetch" href="/blog/assets/js/27.8d87ac3f.js"><link rel="prefetch" href="/blog/assets/js/28.e1e3ee35.js"><link rel="prefetch" href="/blog/assets/js/29.698de22f.js"><link rel="prefetch" href="/blog/assets/js/3.9d9152b8.js"><link rel="prefetch" href="/blog/assets/js/30.583568d8.js"><link rel="prefetch" href="/blog/assets/js/31.ea143d34.js"><link rel="prefetch" href="/blog/assets/js/32.fe48e2d4.js"><link rel="prefetch" href="/blog/assets/js/34.1fec4436.js"><link rel="prefetch" href="/blog/assets/js/35.35cb13dd.js"><link rel="prefetch" href="/blog/assets/js/36.0799adb7.js"><link rel="prefetch" href="/blog/assets/js/37.ea4c6e45.js"><link rel="prefetch" href="/blog/assets/js/38.e6eef6cd.js"><link rel="prefetch" href="/blog/assets/js/39.f21187a2.js"><link rel="prefetch" href="/blog/assets/js/4.68c8a258.js"><link rel="prefetch" href="/blog/assets/js/40.fd71bc09.js"><link rel="prefetch" href="/blog/assets/js/41.e4871cf0.js"><link rel="prefetch" href="/blog/assets/js/42.2293a5fd.js"><link rel="prefetch" href="/blog/assets/js/43.a203256f.js"><link rel="prefetch" href="/blog/assets/js/44.d5025ccd.js"><link rel="prefetch" href="/blog/assets/js/45.553e5875.js"><link rel="prefetch" href="/blog/assets/js/46.e56c63c2.js"><link rel="prefetch" href="/blog/assets/js/47.0919b21b.js"><link rel="prefetch" href="/blog/assets/js/48.53bd59a3.js"><link rel="prefetch" href="/blog/assets/js/49.3761c17a.js"><link rel="prefetch" href="/blog/assets/js/5.364dc182.js"><link rel="prefetch" href="/blog/assets/js/50.769815b0.js"><link rel="prefetch" href="/blog/assets/js/51.feb30ae1.js"><link rel="prefetch" href="/blog/assets/js/52.b9c26cac.js"><link rel="prefetch" href="/blog/assets/js/53.f3610b84.js"><link rel="prefetch" href="/blog/assets/js/54.ed2d6c3b.js"><link rel="prefetch" href="/blog/assets/js/55.82ec5ba6.js"><link rel="prefetch" href="/blog/assets/js/56.05494772.js"><link rel="prefetch" href="/blog/assets/js/57.6c4d31de.js"><link rel="prefetch" href="/blog/assets/js/58.adaea99b.js"><link rel="prefetch" href="/blog/assets/js/59.8d7b110e.js"><link rel="prefetch" href="/blog/assets/js/6.075ad0d6.js"><link rel="prefetch" href="/blog/assets/js/60.a824ac80.js"><link rel="prefetch" href="/blog/assets/js/61.821778f8.js"><link rel="prefetch" href="/blog/assets/js/62.bd3049c3.js"><link rel="prefetch" href="/blog/assets/js/63.2abd2cf8.js"><link rel="prefetch" href="/blog/assets/js/64.25c1b6fa.js"><link rel="prefetch" href="/blog/assets/js/65.5862d6ed.js"><link rel="prefetch" href="/blog/assets/js/66.5e7b6293.js"><link rel="prefetch" href="/blog/assets/js/67.14f68b2e.js"><link rel="prefetch" href="/blog/assets/js/68.1bf58420.js"><link rel="prefetch" href="/blog/assets/js/69.ea9ae14c.js"><link rel="prefetch" href="/blog/assets/js/7.779683fb.js"><link rel="prefetch" href="/blog/assets/js/70.3da48032.js"><link rel="prefetch" href="/blog/assets/js/71.9fe04adc.js"><link rel="prefetch" href="/blog/assets/js/72.bcd62e5a.js"><link rel="prefetch" href="/blog/assets/js/73.10b3f3a9.js"><link rel="prefetch" href="/blog/assets/js/74.e2626435.js"><link rel="prefetch" href="/blog/assets/js/75.8d7fe3e1.js"><link rel="prefetch" href="/blog/assets/js/76.cd208881.js"><link rel="prefetch" href="/blog/assets/js/77.82b6e614.js"><link rel="prefetch" href="/blog/assets/js/78.50700c6c.js"><link rel="prefetch" href="/blog/assets/js/79.e230f5da.js"><link rel="prefetch" href="/blog/assets/js/8.242b22d8.js"><link rel="prefetch" href="/blog/assets/js/80.63dd0422.js"><link rel="prefetch" href="/blog/assets/js/81.f8f1a9c8.js"><link rel="prefetch" href="/blog/assets/js/82.b6211fce.js"><link rel="prefetch" href="/blog/assets/js/83.6cabba5c.js"><link rel="prefetch" href="/blog/assets/js/84.a0dc3dfa.js"><link rel="prefetch" href="/blog/assets/js/85.b370face.js"><link rel="prefetch" href="/blog/assets/js/86.78137d90.js"><link rel="prefetch" href="/blog/assets/js/87.34e58bfd.js"><link rel="prefetch" href="/blog/assets/js/88.268a29b0.js"><link rel="prefetch" href="/blog/assets/js/9.6ee383ea.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.15804160.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><img src="/blog/assets/logo.png" alt="城南花已开" class="logo"> <span class="site-name can-hide">城南花已开</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="日常积累" class="dropdown-title"><span class="title">日常积累</span> <span class="arrow down"></span></button> <button type="button" aria-label="日常积累" class="mobile-dropdown-title"><span class="title">日常积累</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/daily-learn/JavaScript/call-apply-bind-simulator.html" class="nav-link">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/blog/daily-learn/vue/" class="nav-link">
  Vue
</a></li><li class="dropdown-item"><!----> <a href="/blog/daily-learn/CSS/make-talkbubble.html" class="nav-link">
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/blog/daily-learn/PHP/tp51-timestamp-autosave.html" class="nav-link">
  PHP
</a></li><li class="dropdown-item"><!----> <a href="/blog/daily-learn/Git/git-des.html" class="nav-link">
  Git
</a></li><li class="dropdown-item"><!----> <a href="/blog/daily-learn/Scaffold/Introduction.html" class="nav-link">
  Scaffold
</a></li><li class="dropdown-item"><!----> <a href="/blog/daily-learn/HandWriting/Promise.html" class="nav-link">
  HandWriting
</a></li><li class="dropdown-item"><!----> <a href="/blog/daily-learn/Node/Node-Koa1.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Node
</a></li></ul></div></div><div class="nav-item"><a href="/blog/cs-basic/data-structures/base-structures.html" class="nav-link">
  计算机基础
</a></div><div class="nav-item"><a href="/blog/translation/Arrays-symbols-and-realms.html" class="nav-link">
  外文翻译
</a></div> <a href="https://github.com/fengnzl" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="日常积累" class="dropdown-title"><span class="title">日常积累</span> <span class="arrow down"></span></button> <button type="button" aria-label="日常积累" class="mobile-dropdown-title"><span class="title">日常积累</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/daily-learn/JavaScript/call-apply-bind-simulator.html" class="nav-link">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/blog/daily-learn/vue/" class="nav-link">
  Vue
</a></li><li class="dropdown-item"><!----> <a href="/blog/daily-learn/CSS/make-talkbubble.html" class="nav-link">
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/blog/daily-learn/PHP/tp51-timestamp-autosave.html" class="nav-link">
  PHP
</a></li><li class="dropdown-item"><!----> <a href="/blog/daily-learn/Git/git-des.html" class="nav-link">
  Git
</a></li><li class="dropdown-item"><!----> <a href="/blog/daily-learn/Scaffold/Introduction.html" class="nav-link">
  Scaffold
</a></li><li class="dropdown-item"><!----> <a href="/blog/daily-learn/HandWriting/Promise.html" class="nav-link">
  HandWriting
</a></li><li class="dropdown-item"><!----> <a href="/blog/daily-learn/Node/Node-Koa1.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Node
</a></li></ul></div></div><div class="nav-item"><a href="/blog/cs-basic/data-structures/base-structures.html" class="nav-link">
  计算机基础
</a></div><div class="nav-item"><a href="/blog/translation/Arrays-symbols-and-realms.html" class="nav-link">
  外文翻译
</a></div> <a href="https://github.com/fengnzl" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JavaScript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Vue</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>CSS</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>PHP</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Git</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Scaffold</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>HandWriting</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Node</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/daily-learn/Node/Node-Koa1.html" aria-current="page" class="active sidebar-link">Node.js +Koa2 打造web框架(一)</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/daily-learn/Node/Node-Koa1.html#koa2-与异步编程" class="sidebar-link">Koa2 与异步编程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/daily-learn/Node/Node-Koa1.html#中间件" class="sidebar-link">中间件</a></li><li class="sidebar-sub-header"><a href="/blog/daily-learn/Node/Node-Koa1.html#洋葱模型" class="sidebar-link">洋葱模型</a></li><li class="sidebar-sub-header"><a href="/blog/daily-learn/Node/Node-Koa1.html#为什么一定要保证洋葱模型" class="sidebar-link">为什么一定要保证洋葱模型</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/daily-learn/Node/Node-Koa1.html#koa路由系统改造" class="sidebar-link">koa路由系统改造</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/daily-learn/Node/Node-Koa1.html#路由系统" class="sidebar-link">路由系统</a></li><li class="sidebar-sub-header"><a href="/blog/daily-learn/Node/Node-Koa1.html#主题与模型划分" class="sidebar-link">主题与模型划分</a></li><li class="sidebar-sub-header"><a href="/blog/daily-learn/Node/Node-Koa1.html#多router拆分路由" class="sidebar-link">多Router拆分路由</a></li><li class="sidebar-sub-header"><a href="/blog/daily-learn/Node/Node-Koa1.html#nodemon自动重启server" class="sidebar-link">nodemon自动重启Server</a></li><li class="sidebar-sub-header"><a href="/blog/daily-learn/Node/Node-Koa1.html#vscode-nodemon调试配置" class="sidebar-link">vscode+nodemon调试配置</a></li><li class="sidebar-sub-header"><a href="/blog/daily-learn/Node/Node-Koa1.html#requiredirectory实现路由自动注册" class="sidebar-link">requireDirectory实现路由自动注册</a></li><li class="sidebar-sub-header"><a href="/blog/daily-learn/Node/Node-Koa1.html#初始化管理器与process-cwd" class="sidebar-link">初始化管理器与Process.cwd</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/daily-learn/Node/Node-Koa1.html#异步异常与全局异常处理" class="sidebar-link">异步异常与全局异常处理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/daily-learn/Node/Node-Koa1.html#参数获取" class="sidebar-link">参数获取</a></li><li class="sidebar-sub-header"><a href="/blog/daily-learn/Node/Node-Koa1.html#异常理论与异常链" class="sidebar-link">异常理论与异常链</a></li><li class="sidebar-sub-header"><a href="/blog/daily-learn/Node/Node-Koa1.html#异步异常处理方案" class="sidebar-link">异步异常处理方案</a></li><li class="sidebar-sub-header"><a href="/blog/daily-learn/Node/Node-Koa1.html#全局异常处理中间件编写" class="sidebar-link">全局异常处理中间件编写</a></li><li class="sidebar-sub-header"><a href="/blog/daily-learn/Node/Node-Koa1.html#已知错误和未知错误" class="sidebar-link">已知错误和未知错误</a></li><li class="sidebar-sub-header"><a href="/blog/daily-learn/Node/Node-Koa1.html#定义返回异常格式" class="sidebar-link">定义返回异常格式</a></li><li class="sidebar-sub-header"><a href="/blog/daily-learn/Node/Node-Koa1.html#定义httpexception异常基类" class="sidebar-link">定义HttpException异常基类</a></li><li class="sidebar-sub-header"><a href="/blog/daily-learn/Node/Node-Koa1.html#特定异常类与global全局变量" class="sidebar-link">特定异常类与global全局变量</a></li></ul></li></ul></li><li><a href="/blog/daily-learn/Node/node-koa2.html" class="sidebar-link">Node.js +Koa2 打造web框架(二)</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="node-js-koa2-打造web框架-一"><a href="#node-js-koa2-打造web框架-一" class="header-anchor">#</a> Node.js +Koa2 打造web框架(一)</h1> <p>nvm管理不同的node版本，koa<a href="https://koa.bootcss.com/" target="_blank" rel="noopener noreferrer">官方文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><strong>node.js的能力与应用</strong></p> <ol><li>脱离浏览器运行JS</li> <li>NodeJS Stream (前端工程化基础)</li> <li>服务端API</li> <li>作为中间层</li></ol> <p>koa的特点：洋葱圈模型，精简，一般需要二次开发，因此定制化能力强，可以根据开发者的喜好和习惯形成非常好用的高级KOA.</p> <h2 id="koa2-与异步编程"><a href="#koa2-与异步编程" class="header-anchor">#</a> Koa2 与异步编程</h2> <p>首先初始化npm的项目配置文件<code>npm init</code>，然后使用<code>npm i koa</code>进行koa的安装，建立koa的入口文件，首先需要导入<code>koa</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;Koa&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>JavaScrip模块导入导出的几种方式</strong></p> <ol><li><code>common JS</code>导入语句，即上述的require语句</li> <li><code>ES6</code>导入模块或包，使用<code>import from *</code>语句</li> <li>AMD形式导入</li></ol> <p>由于Node中无法直接使用ES6及以上的语法，需要使用<code>babel</code>插件进行编译</p> <p>此时我们实例化Koa，像这种实例化的对象我们一般称之为<strong>应用程序对象</strong>，其特点是在对象上面存在大量的中间件，当我们使用其<code>listen</code>方法时，就可以启动koa</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;Koa&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//应用程序对象</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//3000是未被暂用的端口号</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>在终端中执行<code>app.js</code>文件，此时终端处于未报错，阻塞状态时即说明以成功启动。</p> <h3 id="中间件"><a href="#中间件" class="header-anchor">#</a> 中间件</h3> <p><strong>什么是中间件</strong></p> <ol><li>中间件可以暂时理解为函数，包含一定的功能。通过<strong>app.use</strong>进行注册。</li> <li>中间件的注册存在顺序关系。调用每个中间件存在两个函数，<code>ctx</code>表示上下文，<code>next</code>就表示下一个中间件。</li></ol> <p>如果想调用注册的中间件，则需要前端发送HTTP请求，最简单的方式是从浏览器中发送：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;test&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>test<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>这是开启koa，并访问本地端口<code>http://localhost:3000/</code>，则会打印出test</p> <p><img src="https://raw.githubusercontent.com/fengnzl/HexoImages/master/img/20190804234004.png" alt=""></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">//ctx 上下文  next下一个中间件函数</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;hello,7yue&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 调用下一个中间件函数</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;hello,8yue&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>此时重新请求，开启koa，输出结果如下</p> <p><img src="https://raw.githubusercontent.com/fengnzl/HexoImages/master/img/20190804234428.png" alt=""></p> <p>如果不使用next调用下一个中间件，则不会打印8yue。</p> <h3 id="洋葱模型"><a href="#洋葱模型" class="header-anchor">#</a> 洋葱模型</h3> <p>我们将上面的代码进行修改一下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">//ctx 上下文  next下一个中间件函数</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 调用下一个中间件函数</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>则输出结果为1,3,4,2.这里就是一个洋葱模型，使用<code>next</code>将一个函数分隔成上下两部分，简单的图示如下</p> <p><img src="https://raw.githubusercontent.com/fengnzl/HexoImages/master/img/20190804235505.png" alt=""></p> <p>关于洋葱模型的具体图片，可查看此<a href="https://segmentfault.com/a/1190000013981513" target="_blank" rel="noopener noreferrer">文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><strong>小结</strong>:在中间件的函数前面需要加上<code>async</code>，在<code>next()</code>前面需要加上<code>await</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">//ctx 上下文  next下一个中间件函数</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 调用下一个中间件函数</span>
  <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>这个可以确保中间件是万无一失的，因为node.js大部分是<strong>异步编程</strong>。</p> <p>如果不加上<code>async</code>和<code>await</code>我们很难保证中间件一定是按照洋葱模型的模式执行</p> <h4 id="await特点"><a href="#await特点" class="header-anchor">#</a> <strong>await特点</strong></h4> <p>js是单线程的，有宏任务和微任务的区别。单线程是不可能让线程不工作的，只是会把任务挂起。</p> <ol><li><p><code>await</code>我们可以简单将其认为是<strong>求值关键字</strong>，对返回的promise对象成功时候的结果进行计算转换，其后面可以任意跟上一个表达式，而不仅仅是promise</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token number">100</span><span class="token operator">*</span><span class="token number">100</span><span class="token punctuation">;</span><span class="token comment">//10000</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p><strong>阻塞线程这里是指await语句下所有代码被放进了微任务队列，其重大的意义是将异步调用变为同步调用</strong>。一般的异步操作有: 对资源、读文件、发送HTTP及操作数据库等，例如当我们不使用和使用<code>await</code>时，其请求时间的差别如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// console.log(3);</span>
  <span class="token comment">//引用axios库</span>
  <span class="token keyword">const</span> axios <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;axios&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> start <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//请求网址</span>
  <span class="token comment">//const res = axios.get(&quot;http://7yue.pro&quot;);</span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;http://7yue.pro&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> end <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>end <span class="token operator">-</span> start<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// console.log(4);</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><img src="https://raw.githubusercontent.com/fengnzl/HexoImages/master/img/20190805014742.png" alt=""></p></li></ol> <p>这是由于使用<code>await</code>会阻塞线程，等待异步调用的结果返回后，才能执行后面的代码。</p> <h4 id="async意义"><a href="#async意义" class="header-anchor">#</a> async意义</h4> <p>如果一个函数前加上<code>async</code>关键字，则函数返回的结果会被<strong>强制包装成promise对象</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">fun</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;abc&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">fun</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><img src="https://raw.githubusercontent.com/fengnzl/HexoImages/master/img/20190805015443.png" alt=""></p> <p><strong>中间件函数前面为什么要加上<code>async</code></strong></p> <p>因为中间件函数内部使用<code>await</code>，如果不加上<code>async</code>，则会报错。</p> <p><code>async</code>和<code>await</code>被称为异步的终极解决方案。</p> <h3 id="为什么一定要保证洋葱模型"><a href="#为什么一定要保证洋葱模型" class="header-anchor">#</a> 为什么一定要保证洋葱模型</h3> <p>如果不加上<code>async</code>和<code>await</code>，koa的中间件就不一定会按照洋葱模型的顺序执行，如下图所示：</p> <p><img src="https://raw.githubusercontent.com/fengnzl/HexoImages/master/blog/20190805123346.png" alt=""></p> <p>虽然node是单线程，但是其可以快速切换执行代码片段，看起来像并行执行，因此node是可以处理并发的。</p> <p><strong>保证按洋葱模型的顺序执行的必要条件：</strong></p> <ol><li><font color="red">中间件必须全部使用async函数和await next ()，</font></li> <li>如果有使用普通函数的中间件，其next的async函数中间件包括异步获取数据的，在await阻塞线程获取异步数据时，会执行外层普通函数中间件的next之后的语句。</li></ol> <ul><li>当async函数执行过程中碰到await时，会立刻返回一个promise，等待await执行结果，再执行下面代码。</li> <li>promise属于异步任务，它会等待所有宏任务执行（主线程）执行完毕后才会执行。</li></ul> <p>只有按照洋葱模型方式执行代码，你才能知道后续所有的中间件都已经执行，其以<code>next()</code>函数为界限，之前的代码表名中间件还没有执行，<code>next()</code>之后的代码表示中间件都已执行。</p> <p><strong>多个中间见参数传递</strong></p> <ol><li>通过return的当时进行传递（当使用大量第三方插件时，无法准确的获取）</li> <li>利用<code>ctx</code>上下文参数</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span>
<span class="token comment">// 应用程序对象</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">//next()</span>
  <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>r<span class="token punctuation">)</span><span class="token comment">//100000</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token number">100</span> <span class="token operator">*</span> <span class="token number">1000</span>
  ctx<span class="token punctuation">.</span>r <span class="token operator">=</span> res
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span> <span class="token comment">// 3000是未被暂用的端口号</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>如果不加<code>async</code>和<code>await</code>，其不能保证中间件的执行顺序按洋葱模型执行，因此会打印出<code>undefined</code></p> <h2 id="koa路由系统改造"><a href="#koa路由系统改造" class="header-anchor">#</a> koa路由系统改造</h2> <h3 id="路由系统"><a href="#路由系统" class="header-anchor">#</a> 路由系统</h3> <p>如果要获得请求的路径和方法等可以参考<a href="https://koa.bootcss.com/#request" target="_blank" rel="noopener noreferrer">官方文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。<strong><code>ctx.</code>与<code>request.</code>是等效的</strong>，浏览器默认的请求就是GET请求</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span>
<span class="token comment">// 应用程序对象</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>method<span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>path<span class="token punctuation">)</span> 
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'GET'</span> <span class="token operator">&amp;&amp;</span> ctx<span class="token punctuation">.</span>path <span class="token operator">==</span> <span class="token string">'/classic/latest'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'classic'</span> <span class="token comment">//将最终结果返回到客户端</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//调用下一个中间件</span>
  <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span> <span class="token comment">// 3000是未被暂用的端口号</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p><img src="https://raw.githubusercontent.com/fengnzl/HexoImages/master/blog/20190805202655.png" alt=""></p> <p>注意这里必须要将返回的值赋值到<code>ctx.body</code>中，否则客户端无法接收，如果要返回<code>json</code>格式的数据，则将数据以JavaScript对象的形式赋值给<code>ctx.body</code>，koa内部会自动将其转换为json数据格式</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code> ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token literal-property property">key</span><span class="token operator">:</span><span class="token string">'classic'</span><span class="token punctuation">}</span><span class="token comment">// {&quot;key&quot;:&quot;classic&quot;}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>上面是一种简易的路由，在koa中我们一般使用<code>koa-router</code>这个<a href="https://www.npmjs.com/package/koa-router" target="_blank" rel="noopener noreferrer">路由中间件<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h4 id="引入koa-router"><a href="#引入koa-router" class="header-anchor">#</a> 引入koa-router</h4> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> Router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@koa/router'</span><span class="token punctuation">)</span><span class="token comment">// 引入koa-router</span>
<span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span> <span class="token comment">// 引入路由</span>
<span class="token comment">// 应用程序对象 中间件</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">// 实例化路由</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/classic/latest'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token literal-property property">key</span><span class="token operator">:</span><span class="token string">'classic'</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">// 将路由注册到中间件上</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>Restful API 的主要四个操作： get 查询，post 新增，put修改 以及delete 删除</p> <h3 id="主题与模型划分"><a href="#主题与模型划分" class="header-anchor">#</a> 主题与模型划分</h3> <p>对于一个项目，我们应该对路由按照主题进行拆分，将路由分别写到不同的文件中。</p> <p>基本主题的划分逻辑，我们可以根据数据类型进行划分，好的主题划分，数据库的设计也相对而言比较简单，主题的划分是渐进式的，首先划分的是核心主题，后期随着开发慢慢补充数据</p> <h3 id="多router拆分路由"><a href="#多router拆分路由" class="header-anchor">#</a> 多Router拆分路由</h3> <p>Api版本：一般是业务变更，需要考虑到老版本的兼容性，因此需要设计多个api版本，版本越多，成本越高。</p> <p><strong>api版本号的携带的三种方式</strong></p> <ol><li>路径中：/v1/classic/latest</li> <li>查询参数：/classic/latest?version=v1</li> <li>通过http中的header携带</li></ol> <p>代码应当遵循<strong>开闭原则</strong>修改关闭，扩展开放</p> <p>注意<strong>避免循环引用</strong>，因为nodejs对循环引用不会报错，很难排查问题。应该是上层调用下层，而不能反过来调用。</p> <p>​     我们可以在每个路由文件中编写路由然后在入口文件引入注册即可</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//book.js路由文件</span>
<span class="token keyword">const</span> Router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@koa/router'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/v1/book/latest'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">key</span><span class="token operator">:</span><span class="token string">'book'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">book</span><span class="token operator">:</span>router <span class="token comment">// 如果键名与值相同，则可以简写为值名 router</span>
<span class="token punctuation">}</span>

<span class="token comment">// classic.js文件</span>
<span class="token keyword">const</span> Router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@koa/router'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/v1/classic/latest'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  ctx<span class="token punctuation">.</span>body<span class="token operator">=</span><span class="token punctuation">{</span>
    <span class="token literal-property property">key</span><span class="token operator">:</span><span class="token string">'classic'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
module<span class="token punctuation">.</span>exports<span class="token operator">=</span> router

<span class="token comment">//app.js  入口文件</span>
<span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span> <span class="token comment">// 引入路由</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>book<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./app/api/v1/book'</span><span class="token punctuation">)</span> <span class="token comment">// 如果以对象的形式导出 则引入也必须为对象</span>
<span class="token keyword">const</span> classic <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./app/api/v1/classic'</span><span class="token punctuation">)</span>
<span class="token comment">// 应用程序对象 中间件</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>book<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">// 将路由注册到中间件上</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>classic<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span> <span class="token comment">// 3000是未被暂用的端口号</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p><img src="https://raw.githubusercontent.com/fengnzl/HexoImages/master/blog/20190806211849.png" alt=""></p> <h3 id="nodemon自动重启server"><a href="#nodemon自动重启server" class="header-anchor">#</a> nodemon自动重启Server</h3> <p>使用vscode断点调试时，在需要调试的地方打上断点，然后按F5即进入断点调试，此时就与平时断点调试步骤一样。</p> <p>安装<code>nodemon</code>用于自动重启Server，建议全局安装，直接输入nodemon即可启动</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>npm i nodemon <span class="token operator">-</span>g
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>如果安装在当前项目文件，则有两种方法可以启动<code>nodemon</code></p> <ol><li>使用命令 <code>npx nodemon</code></li> <li>在package.json文件中添加脚本，使用设置的快捷键启动</li></ol> <p>此时我们只要修改文件后进行保存，<code>nodemon</code>就会自动重启node服务</p> <p><img src="https://raw.githubusercontent.com/fengnzl/HexoImages/master/blog/20190806213355.png" alt=""></p> <h3 id="vscode-nodemon调试配置"><a href="#vscode-nodemon调试配置" class="header-anchor">#</a> vscode+nodemon调试配置</h3> <p>首先我们需要生成配置文件，如下图所示我们即可在项目文件中看到生成的配置文件<code>.vscode/launch.json</code></p> <p><img src="https://raw.githubusercontent.com/fengnzl/HexoImages/master/blog/20190806213611.png" alt=""></p> <p>在配置文件中默认的启动文件是<code>app.js</code>文件，我们可以进行添加，使其拥有多种启动方式，其中点击添加配置选择<code>nodemon</code>可以自动帮我们配置<code>nodemon</code>的调试配置，同时，由于默认进入的是入口文件，我们还需配置在当前文件即可断点调试的配置</p> <p><img src="https://raw.githubusercontent.com/fengnzl/HexoImages/master/blog/20190806214442.png" alt=""></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token comment">// Use IntelliSense to learn about possible attributes.</span>
  <span class="token comment">// Hover to view descriptions of existing attributes.</span>
  <span class="token comment">// For more information, visit: https://go.microsoft.com/fwlink/?linkid=830387</span>
  <span class="token string-property property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;0.2.0&quot;</span><span class="token punctuation">,</span>
  <span class="token string-property property">&quot;configurations&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token string-property property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;node&quot;</span><span class="token punctuation">,</span>
      <span class="token string-property property">&quot;request&quot;</span><span class="token operator">:</span> <span class="token string">&quot;launch&quot;</span><span class="token punctuation">,</span>
      <span class="token string-property property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;nodemon&quot;</span><span class="token punctuation">,</span>
      <span class="token string-property property">&quot;runtimeExecutable&quot;</span><span class="token operator">:</span> <span class="token string">&quot;nodemon&quot;</span><span class="token punctuation">,</span>
      <span class="token string-property property">&quot;program&quot;</span><span class="token operator">:</span> <span class="token string">&quot;${workspaceFolder}/app.js&quot;</span><span class="token punctuation">,</span>
      <span class="token string-property property">&quot;restart&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token string-property property">&quot;console&quot;</span><span class="token operator">:</span> <span class="token string">&quot;integratedTerminal&quot;</span><span class="token punctuation">,</span>
      <span class="token string-property property">&quot;internalConsoleOptions&quot;</span><span class="token operator">:</span> <span class="token string">&quot;neverOpen&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token string-property property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;node&quot;</span><span class="token punctuation">,</span>
      <span class="token string-property property">&quot;request&quot;</span><span class="token operator">:</span> <span class="token string">&quot;launch&quot;</span><span class="token punctuation">,</span>
      <span class="token string-property property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Launch Program&quot;</span><span class="token punctuation">,</span>
      <span class="token string-property property">&quot;program&quot;</span><span class="token operator">:</span> <span class="token string">&quot;${workspaceFolder}/app.js&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token string-property property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;node&quot;</span><span class="token punctuation">,</span>
      <span class="token string-property property">&quot;request&quot;</span><span class="token operator">:</span> <span class="token string">&quot;launch&quot;</span><span class="token punctuation">,</span>
      <span class="token string-property property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;当前文件&quot;</span><span class="token punctuation">,</span> <span class="token comment">//名称可以随意设置</span>
      <span class="token string-property property">&quot;program&quot;</span><span class="token operator">:</span> <span class="token string">&quot;${file}&quot;</span><span class="token comment">//设置为当前所选文件名</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>此时，选择使用<code>nodemon</code>的调试配置，即可实现<code>vscode+nodemon</code>的调试配置</p> <h3 id="requiredirectory实现路由自动注册"><a href="#requiredirectory实现路由自动注册" class="header-anchor">#</a> requireDirectory实现路由自动注册</h3> <p>首先我们需要安装<code>require-directory</code>的安装包，其<a href="https://www.npmjs.com/package/require-directory" target="_blank" rel="noopener noreferrer">使用文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>npm i require<span class="token operator">-</span>directory
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>然后在入口文件引入即可，然后通过调用，填入相关参数（module(固定)，模块路径）即可将路径下所有的模块添加到modules变量里</p> <p><img src="https://raw.githubusercontent.com/fengnzl/HexoImages/master/blog/20190806220426.png" alt=""></p> <p>其还可以接收第三个参数，这是一个函数，相当于一个回调函数，否则就需要我们进行循环判断导出的是否为路由模块。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> Router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@koa/router'</span><span class="token punctuation">)</span> <span class="token comment">// 引入路由</span>
<span class="token keyword">const</span> requireDirectory <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'require-directory'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span> <span class="token comment">// 引入koa</span>
<span class="token comment">// 应用程序对象 中间件</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token function">requireDirectory</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> <span class="token string">'./app/api/v1'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">visit</span><span class="token operator">:</span> whenLoadModule
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">whenLoadModule</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 如果不是以对象形式导出</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>obj <span class="token keyword">instanceof</span> <span class="token class-name">Router</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 判断以对象形式导出的属性中 是否有Router</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token keyword">in</span> obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>obj<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword">instanceof</span> <span class="token class-name">Router</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 只传入两个参数的情况</span>
<span class="token comment">// const modules = requireDirectory(module,'./app/api/v1') </span>

<span class="token comment">// for (var r in modules) {</span>
<span class="token comment">//   if (r instanceof Router) {</span>
<span class="token comment">//     app.use(r.routes())// 注册路由</span>
<span class="token comment">//   }</span>
<span class="token comment">// }</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span> <span class="token comment">// 3000是未被暂用的端口号</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><h3 id="初始化管理器与process-cwd"><a href="#初始化管理器与process-cwd" class="header-anchor">#</a> 初始化管理器与Process.cwd</h3> <p>由于入口文件不应放置太多的代码，因此我们需要对其重构，将其中的部分代码分离出去，首先我们需要建立一个<code>core</code>文件夹，用于放置初始化文件和函数文件，这里我们新建一个初始化文件<code>init.js</code>，在里面创建初始化管理器类，具体代码如下</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">/</span>core<span class="token operator">/</span>init<span class="token punctuation">.</span>js

<span class="token keyword">const</span> requireDirectory <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'require-directory'</span><span class="token punctuation">)</span> <span class="token comment">// 引入文件夹管理插件</span>
<span class="token keyword">const</span> Router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@koa/router'</span><span class="token punctuation">)</span> <span class="token comment">// 引入路由</span>
<span class="token comment">// 初始化管理器类</span>
<span class="token keyword">class</span> <span class="token class-name">InitManager</span><span class="token punctuation">{</span>
  <span class="token comment">// 设置入口方法</span>
  <span class="token keyword">static</span> <span class="token function">initCore</span><span class="token punctuation">(</span><span class="token parameter">app</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 将传入的参数设置在类的属性上 或者通过函数传参的方式传递</span>
    InitManager<span class="token punctuation">.</span>app <span class="token operator">=</span> app
     <span class="token comment">// 调用类中的方法</span>
     InitManager<span class="token punctuation">.</span><span class="token function">initRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
     <span class="token comment">//InitManager.initRouter(app)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 设置初始化路由方法 其中[app]代表使用函数传参的方式进行app的相关调用</span>
  <span class="token keyword">static</span> <span class="token function">initRouter</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">[</span>app<span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 路由自动注册函数 param: 模块 路径 及模块引入后的回调函数</span>
    <span class="token function">requireDirectory</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> <span class="token string">'../app/api'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">visit</span><span class="token operator">:</span> whenLoadModule
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// 路由注册函数</span>
    <span class="token keyword">function</span> <span class="token function">whenLoadModule</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>obj <span class="token keyword">instanceof</span> <span class="token class-name">Router</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 将路由注册在中间件</span>
        InitManager<span class="token punctuation">.</span>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment">// app.use(obj.routes())</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 通过对象的形式导出模块</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token keyword">in</span> obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>obj<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword">instanceof</span> <span class="token class-name">Router</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            InitManager<span class="token punctuation">.</span>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment">// app.use(obj[i].routes())</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 导出模块</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> InitManager
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><p>入口文件代码如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">/</span>app<span class="token punctuation">.</span>js

<span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span> <span class="token comment">// 引入koa</span>
<span class="token keyword">const</span> InitManager <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./core/init'</span><span class="token punctuation">)</span> <span class="token comment">// 引入初始化管理器</span>
<span class="token comment">// 应用程序对象 中间件</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// 调用初始化管理器中的初始化方法</span>
InitManager<span class="token punctuation">.</span><span class="token function">initCore</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span> <span class="token comment">// 3000是未被暂用的端口号</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>由于在调用路由自动注册函数时，需要使用文件路径，这里使用的是硬编码的方式，这是不推荐的，更好的引用方式有以下了两种：</p> <p><strong>文件路径设置</strong></p> <ol><li>将相关文件位置自行配置文件中</li> <li>通过nodejs提供的绝对路径函数<code>process.cwd</code></li></ol> <p>这里改写文件如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>  <span class="token comment">// 当前项目的绝对路径</span>
    <span class="token keyword">let</span> apiDirectory <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/app/api</span><span class="token template-punctuation string">`</span></span>
    <span class="token comment">// 路由自动注册函数 param: 模块 路径 及模块引入后的回调函数</span>
    <span class="token function">requireDirectory</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> apiDirectory<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">visit</span><span class="token operator">:</span> whenLoadModule
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>或者使用配置文件</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// config.js</span>
<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">apiDirectory</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/app/api</span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> config<span class="token punctuation">;</span>


<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> Config <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">apiDirectory</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">'/app/api/v1'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Config

<span class="token comment">// init.js</span>
<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;../config&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> apiDirectory <span class="token operator">=</span> config<span class="token punctuation">.</span>apiDirectory<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h2 id="异步异常与全局异常处理"><a href="#异步异常与全局异常处理" class="header-anchor">#</a> 异步异常与全局异常处理</h2> <h3 id="参数获取"><a href="#参数获取" class="header-anchor">#</a> 参数获取</h3> <p>常见的参数传递的四种方法</p> <ol><li>在url路径中传参 <code>/v1/:id/latest</code></li> <li>通过在url路径<code>?</code>之后带查询参数</li> <li>通过<code>http</code>的<code>body</code>传参</li> <li>通过<code>http</code>的<code>header</code>传参</li></ol> <p>而在koa中对应着以下四个方法来获取参数</p> <ul><li><p>获取path方式传递的参数<code>ctx.params</code></p></li> <li><p>获取query方式传递的参数<code>ctx.request.query</code></p></li> <li><p>获取header方式传递的参数<code>ctx.request.header</code></p></li> <li><p>获取body方式传递的参数，需要安装<code>koa-bodyparser</code>中间件，通过<code>ctx.request.body</code>进行获取，具体使用如下</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//入口文件 app.js</span>
<span class="token keyword">const</span> parser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-bodyparser'</span><span class="token punctuation">)</span><span class="token comment">// 引入bodyparser 中间件</span>
<span class="token comment">// 应用程序对象 中间件</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// 注册中间件</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">parser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>校验参数的作用：防止非法请求，给客户端提供提示</p></li></ul> <h3 id="异常理论与异常链"><a href="#异常理论与异常链" class="header-anchor">#</a> 异常理论与异常链</h3> <p>首先我们在调用函数时会出现以下两种结果：</p> <ol><li>没有发生异常，正确返回结果</li> <li>发生异常</li></ol> <p>在函数设计时，我们需要判断出异常，然后进行处理，这里也有两种方式：</p> <ol><li><p>return false /null</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">fun2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> r <span class="token operator">=</span> <span class="token function">fun3</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>r<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">fun3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div></li> <li><p><strong>按照编程规范，应该<code>throw new Error</code></strong></p></li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">fun3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//success</span>
<span class="token keyword">function</span> <span class="token function">fun3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token number">1</span><span class="token operator">/</span><span class="token number">0</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> error
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token string">'success'</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>这里没有抛出异常，是因为在JavaScript中<code>1/0=infinity</code>，这场情况下的异常链条如下</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">fun1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token function">fun2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">throw</span> error
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">fun2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token function">fun3</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> error
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">fun3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token number">1</span><span class="token operator">/</span>a
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> error
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token string">'success'</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>但最好的是，设计一种机制，可以监听到各种异常，这就需要全局异常处理机制</p> <h3 id="异步异常处理方案"><a href="#异步异常处理方案" class="header-anchor">#</a> 异步异常处理方案</h3> <p><code>try-catch</code>捕捉异常通常只对同步起作用，对异步操作一般无法捕获</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">fun1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token function">fun2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;err&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">fun2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;error&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">fun1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>上面代码是一个简单模拟异步操作的过程，结果是直接抛出一个错误，而没有打印出<code>err</code>，这是因为执行<code>setTimeout</code>操作时候，立即就return出去，其中的回调函数可能还没有执行，所以无法捕捉。</p> <p>因此在异步编程处理的时候，如果某一个函数函数返回的是**<code>promise</code>对象**时，我们就可以使用<code>async</code>及<code>await</code>来处理异步编程，同时在异常链中如果一个函数中使用了<code>async</code>和<code>await</code>，则所有的函数都需使用这两个关键字</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">fun1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> <span class="token function">fun2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;err&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">fun2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> r <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">&lt;</span> <span class="token number">0.5</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">&quot;error&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">fun1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>简单的异步异常处理方案如上所示，一定要返回的是一个<code>promise</code>对象，当返回错误时，就是输出<code>err</code>,同时注意<code>setTimeout</code>虽然是一个异步函数，但由于其本身只负责执行函数并不返回结果，所以也就无法返回<code>promise</code>，通过promise自身返回的异常，await进行获取时，如果发生错误，可以当作自行抛出了错误。</p> <h3 id="全局异常处理中间件编写"><a href="#全局异常处理中间件编写" class="header-anchor">#</a> 全局异常处理中间件编写</h3> <p>我们通过编写koa的中间件来进行全局异常的监听及返回相关信息。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// ./midewares/exception.js</span>
<span class="token keyword">const</span> <span class="token function-variable function">catchError</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">&quot;浏览器错误，请稍后重试&quot;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> catchError<span class="token punctuation">;</span>

<span class="token comment">//app.js文件进行注册</span>
<span class="token keyword">const</span> catchError <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./middlewares/exception&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>catchError<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//在接口文件抛出错误</span>
<span class="token operator">/</span>app<span class="token operator">/</span>api<span class="token operator">/</span>v1<span class="token operator">/</span>classic<span class="token punctuation">.</span>js
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/v1/classic/latest&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token string">&quot;error&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">index</span><span class="token operator">:</span> <span class="token string">&quot;classic&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>此时我们在浏览器请求接口时，就会获得返回的错误信息</p> <p><img src="https://raw.githubusercontent.com/fengnzl/HexoImages/master/img/20190809005019.png" alt=""></p> <p>这里用的是aop编程的思想即<strong>这种在运行时，动态地将代码切入到类的指定方法、指定位置上的编程思想就是面向切面的编程。</strong></p> <h3 id="已知错误和未知错误"><a href="#已知错误和未知错误" class="header-anchor">#</a> 已知错误和未知错误</h3> <p>在实际项目中我们捕捉到的错误不应该直接返回到客户端中，因此需要对错误进行简化，返回给前端清晰明了的错误信息：</p> <ol><li><code>http status code</code>即http的<a href="https://koa.bootcss.com/" target="_blank" rel="noopener noreferrer">请求状态码<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><code>msg</code>错误信息字段</li> <li><code>err_code</code>错误码，自定义的，同时比http请求状态码要丰富</li> <li><code>request_url</code>当前请求的url</li></ol> <p>错误分为已知行错误和未知型错误（程序潜在的错误）</p> <p>已知错误一般是用户传递参数不符合校验规则等错误，未知错误则是无意识的，根本不知道什么地方出现的错误。</p> <h3 id="定义返回异常格式"><a href="#定义返回异常格式" class="header-anchor">#</a> 定义返回异常格式</h3> <p>这里我们以简单的已知错误为例，模拟异常返回需呀携带的参数，首先我们需要实例化一个<code>Error</code>然后在进行抛出</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// app/api/v1/classic.js</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/v1/classic/latest&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 实例化错误并设置错误信息</span>
    <span class="token comment">// const err = new Error();</span>
    <span class="token comment">// err.message = &quot;this is an error&quot;;</span>
    <span class="token keyword">const</span> err <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;this is an error&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 设置http状态码</span>
    err<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">400</span><span class="token punctuation">;</span>
    <span class="token comment">// 设置错误码</span>
    err<span class="token punctuation">.</span>errorCode <span class="token operator">=</span> <span class="token number">10001</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取的请求的方法及url</span>
    err<span class="token punctuation">.</span>requestUrl <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ctx<span class="token punctuation">.</span>method<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ctx<span class="token punctuation">.</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token comment">// 抛出错误</span>
    <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ctx.body = {</span>
  <span class="token comment">//   index: &quot;classic&quot;</span>
  <span class="token comment">// };</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// midewares/exception.js</span>
<span class="token keyword">const</span> <span class="token function-variable function">catchError</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 判断是否存在错误码</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">.</span>errorCode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">msg</span><span class="token operator">:</span> error<span class="token punctuation">.</span>message<span class="token punctuation">,</span>
        <span class="token literal-property property">errorCode</span><span class="token operator">:</span> error<span class="token punctuation">.</span>errorCode<span class="token punctuation">,</span>
        <span class="token literal-property property">requestUrl</span><span class="token operator">:</span> error<span class="token punctuation">.</span>requestUrl
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
      ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> error<span class="token punctuation">.</span>status<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> catchError<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><p>在postman模拟请求可以接收到如下信息</p> <p><img src="https://raw.githubusercontent.com/fengnzl/HexoImages/master/img/20190811112614.png" alt=""></p> <p>但是这样的写法非常麻烦，因此我们使用面向对象的思想来进行处理错误</p> <h3 id="定义httpexception异常基类"><a href="#定义httpexception异常基类" class="header-anchor">#</a> 定义HttpException异常基类</h3> <p>我们将已知错误通过单独<code>HttpException</code>类进行处理，然后在相应地方进行捕获抛出</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">/</span>core<span class="token operator">/</span>http<span class="token operator">-</span>exception<span class="token punctuation">.</span>js
<span class="token comment">// 创建http异常处理类继承Error</span>
<span class="token keyword">class</span> <span class="token class-name">HttpException</span> <span class="token keyword">extends</span> <span class="token class-name">Error</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>msg <span class="token operator">=</span> <span class="token string">&quot;服务器错误&quot;</span><span class="token punctuation">,</span> errorCode <span class="token operator">=</span> <span class="token number">10000</span><span class="token punctuation">,</span> code <span class="token operator">=</span> <span class="token number">400</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 调用基类构造函数</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 错误信息</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>msg <span class="token operator">=</span> msg<span class="token punctuation">;</span>
    <span class="token comment">// 自定义错误码</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>errorCode <span class="token operator">=</span> errorCode<span class="token punctuation">;</span>
    <span class="token comment">// http请求状态码</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>code <span class="token operator">=</span> code<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  HttpException
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token operator">/</span>middleware<span class="token operator">/</span>exception<span class="token punctuation">.</span>js
<span class="token comment">// 以对象形式导出，则必须以对象形式导入</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> HttpException <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;../core/http-exception&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">catchError</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 判断错误是否是已知错误</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>error <span class="token keyword">instanceof</span> <span class="token class-name">HttpException</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">msg</span><span class="token operator">:</span> error<span class="token punctuation">.</span>msg<span class="token punctuation">,</span>
        <span class="token literal-property property">errorCode</span><span class="token operator">:</span> error<span class="token punctuation">.</span>errorCode<span class="token punctuation">,</span>
        <span class="token literal-property property">requestUrl</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ctx<span class="token punctuation">.</span>method<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ctx<span class="token punctuation">.</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
      ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> error<span class="token punctuation">.</span>code<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> catchError<span class="token punctuation">;</span>

<span class="token operator">/</span>app<span class="token operator">/</span>api<span class="token operator">/</span>v1<span class="token operator">/</span>classic<span class="token punctuation">.</span>js
<span class="token keyword">const</span> Router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@koa/router&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> HttpException <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;../../../core/http-exception&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/v1/classic/latest&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> err <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpException</span><span class="token punctuation">(</span><span class="token string">&quot;this is an afdasr&quot;</span><span class="token punctuation">,</span> <span class="token number">10001</span><span class="token punctuation">,</span> <span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 抛出错误</span>
    <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ctx.body = {</span>
  <span class="token comment">//   index: &quot;classic&quot;</span>
  <span class="token comment">// };</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">classic</span><span class="token operator">:</span> router <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br></div></div><h3 id="特定异常类与global全局变量"><a href="#特定异常类与global全局变量" class="header-anchor">#</a> 特定异常类与global全局变量</h3> <p>由于我们会在判断各种异常时，每次都需要传递参数，这样会有些麻烦，我们可以定义一些常用的异常类，这样就可以直接调用具体的异常类，而不是每次都需要传递新参数</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">/</span>core<span class="token operator">/</span>http<span class="token operator">-</span>exception<span class="token punctuation">.</span>js
<span class="token keyword">class</span> <span class="token class-name">ParameterException</span> <span class="token keyword">extends</span> <span class="token class-name">HttpException</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">msg<span class="token punctuation">,</span> errorCode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>errorCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>code <span class="token operator">=</span> <span class="token number">400</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>msg <span class="token operator">=</span> msg <span class="token operator">||</span> <span class="token string">&quot;参数错误&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>errorCode <span class="token operator">=</span> errorCode <span class="token operator">||</span> <span class="token number">10001</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  HttpException<span class="token punctuation">,</span>
  ParameterException
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token operator">/</span>app<span class="token operator">/</span>api<span class="token operator">/</span>v1<span class="token operator">/</span>classic<span class="token punctuation">.</span>js

<span class="token keyword">const</span> Router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@koa/router&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> ParameterException <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;../../../core/http-exception&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/v1/classic/latest&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> err <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ParameterException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 抛出错误</span>
    <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ctx.body = {</span>
  <span class="token comment">//   index: &quot;classic&quot;</span>
  <span class="token comment">// };</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">classic</span><span class="token operator">:</span> router <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token operator">/</span>middleware<span class="token operator">/</span>exception<span class="token punctuation">.</span>js
<span class="token keyword">const</span> <span class="token punctuation">{</span> HttpException<span class="token punctuation">,</span> ParameterException <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;../core/http-exception&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">catchError</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 判断错误是否是已知错误</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>error <span class="token keyword">instanceof</span> <span class="token class-name">ParameterException</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">msg</span><span class="token operator">:</span> error<span class="token punctuation">.</span>msg<span class="token punctuation">,</span>
        <span class="token literal-property property">errorCode</span><span class="token operator">:</span> error<span class="token punctuation">.</span>errorCode<span class="token punctuation">,</span>
        <span class="token literal-property property">requestUrl</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ctx<span class="token punctuation">.</span>method<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ctx<span class="token punctuation">.</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
      ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> error<span class="token punctuation">.</span>code<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> catchError<span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br></div></div><p>如果觉得每次导入特定异常类比较麻烦，我们可以将其设置为global全局变量</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">/</span>core<span class="token operator">/</span>init<span class="token punctuation">.</span>js
 <span class="token comment">// 将异常处理类设置为全局变量</span>
  <span class="token keyword">static</span> <span class="token function">initException</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> errors <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./http-exception&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    global<span class="token punctuation">.</span>errs <span class="token operator">=</span> errors<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 初始化配置时调用此函数</span>
   <span class="token keyword">static</span> <span class="token function">initCore</span><span class="token punctuation">(</span><span class="token parameter">app</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    InitManager<span class="token punctuation">.</span>app <span class="token operator">=</span> app<span class="token punctuation">;</span>
    InitManager<span class="token punctuation">.</span><span class="token function">initRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    InitManager<span class="token punctuation">.</span><span class="token function">initException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token comment">// 在抛出异常时无需在引入模块，按以下方法直接调用即可</span>
<span class="token keyword">const</span> err <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">global<span class="token punctuation">.</span>errs<span class="token punctuation">.</span>ParameterException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 抛出错误</span>
<span class="token keyword">throw</span> err<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>针对未知错误我们直接做以下处理：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">/</span>mideware<span class="token operator">/</span>exception<span class="token punctuation">.</span>js
<span class="token keyword">const</span> <span class="token function-variable function">catchError</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 判断错误是否是已知错误</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>error <span class="token keyword">instanceof</span> <span class="token class-name">ParameterException</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">msg</span><span class="token operator">:</span> error<span class="token punctuation">.</span>msg<span class="token punctuation">,</span>
        <span class="token literal-property property">errorCode</span><span class="token operator">:</span> error<span class="token punctuation">.</span>errorCode<span class="token punctuation">,</span>
        <span class="token literal-property property">requestUrl</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ctx<span class="token punctuation">.</span>method<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ctx<span class="token punctuation">.</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
      ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> error<span class="token punctuation">.</span>code<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 是未知错误</span>
      ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">msg</span><span class="token operator">:</span> <span class="token string">&quot;发生了未知错误:)&quot;</span><span class="token punctuation">,</span>
        <span class="token literal-property property">errCode</span><span class="token operator">:</span> <span class="token number">999</span><span class="token punctuation">,</span>
        <span class="token literal-property property">requestUrl</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ctx<span class="token punctuation">.</span>method<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ctx<span class="token punctuation">.</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
      ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">500</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> catchError<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>则在相应的接口发生未知错误时，就会出现提示：</p> <p><img src="https://raw.githubusercontent.com/fengnzl/HexoImages/master/img/20190811171440.png" alt=""></p> <p><img src="https://raw.githubusercontent.com/fengnzl/HexoImages/master/img/20190811171500.png" alt=""></p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/fengnzl/vuepress-blog/edit/master/docs/daily-learn/Node/Node-Koa1.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">12/10/2022, 4:19:06 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/daily-learn/HandWriting/ArrayReduce.html" class="prev">
        实现一个 reduce
      </a></span> <span class="next"><a href="/blog/daily-learn/Node/node-koa2.html">
        Node.js +Koa2 打造web框架(二)
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><div></div></div></div>
    <script src="/blog/assets/js/app.2cc39ea3.js" defer></script><script src="/blog/assets/js/2.fb25410d.js" defer></script><script src="/blog/assets/js/33.a282bb1e.js" defer></script>
  </body>
</html>
