<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>通过 PNPM workspaces 创建 Monorepo 并使用 Nx 加速！ | 城南花已开</title>
    <meta name="generator" content="VuePress 1.8.3">
    <link rel="icon" href="/blog/assets/logo.ico">
    <meta name="description" content="所爱隔山海，城南花已开">
    
    <link rel="preload" href="/blog/assets/css/0.styles.15804160.css" as="style"><link rel="preload" href="/blog/assets/js/app.2cc39ea3.js" as="script"><link rel="preload" href="/blog/assets/js/2.fb25410d.js" as="script"><link rel="preload" href="/blog/assets/js/80.63dd0422.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.497e2948.js"><link rel="prefetch" href="/blog/assets/js/11.b4461378.js"><link rel="prefetch" href="/blog/assets/js/12.ed4ac828.js"><link rel="prefetch" href="/blog/assets/js/13.5dd73a9c.js"><link rel="prefetch" href="/blog/assets/js/14.31f9a01b.js"><link rel="prefetch" href="/blog/assets/js/15.9a23c20a.js"><link rel="prefetch" href="/blog/assets/js/16.39eadc81.js"><link rel="prefetch" href="/blog/assets/js/17.254cea96.js"><link rel="prefetch" href="/blog/assets/js/18.23b5d51c.js"><link rel="prefetch" href="/blog/assets/js/19.e1755fff.js"><link rel="prefetch" href="/blog/assets/js/20.9f8568a1.js"><link rel="prefetch" href="/blog/assets/js/21.8a27a340.js"><link rel="prefetch" href="/blog/assets/js/22.f8967a83.js"><link rel="prefetch" href="/blog/assets/js/23.e5122aa7.js"><link rel="prefetch" href="/blog/assets/js/24.a6eab485.js"><link rel="prefetch" href="/blog/assets/js/25.61cd9fb4.js"><link rel="prefetch" href="/blog/assets/js/26.c967bdd1.js"><link rel="prefetch" href="/blog/assets/js/27.8d87ac3f.js"><link rel="prefetch" href="/blog/assets/js/28.e1e3ee35.js"><link rel="prefetch" href="/blog/assets/js/29.698de22f.js"><link rel="prefetch" href="/blog/assets/js/3.9d9152b8.js"><link rel="prefetch" href="/blog/assets/js/30.583568d8.js"><link rel="prefetch" href="/blog/assets/js/31.ea143d34.js"><link rel="prefetch" href="/blog/assets/js/32.fe48e2d4.js"><link rel="prefetch" href="/blog/assets/js/33.a282bb1e.js"><link rel="prefetch" href="/blog/assets/js/34.1fec4436.js"><link rel="prefetch" href="/blog/assets/js/35.35cb13dd.js"><link rel="prefetch" href="/blog/assets/js/36.0799adb7.js"><link rel="prefetch" href="/blog/assets/js/37.ea4c6e45.js"><link rel="prefetch" href="/blog/assets/js/38.e6eef6cd.js"><link rel="prefetch" href="/blog/assets/js/39.f21187a2.js"><link rel="prefetch" href="/blog/assets/js/4.68c8a258.js"><link rel="prefetch" href="/blog/assets/js/40.fd71bc09.js"><link rel="prefetch" href="/blog/assets/js/41.e4871cf0.js"><link rel="prefetch" href="/blog/assets/js/42.2293a5fd.js"><link rel="prefetch" href="/blog/assets/js/43.a203256f.js"><link rel="prefetch" href="/blog/assets/js/44.d5025ccd.js"><link rel="prefetch" href="/blog/assets/js/45.553e5875.js"><link rel="prefetch" href="/blog/assets/js/46.e56c63c2.js"><link rel="prefetch" href="/blog/assets/js/47.0919b21b.js"><link rel="prefetch" href="/blog/assets/js/48.53bd59a3.js"><link rel="prefetch" href="/blog/assets/js/49.3761c17a.js"><link rel="prefetch" href="/blog/assets/js/5.364dc182.js"><link rel="prefetch" href="/blog/assets/js/50.769815b0.js"><link rel="prefetch" href="/blog/assets/js/51.feb30ae1.js"><link rel="prefetch" href="/blog/assets/js/52.b9c26cac.js"><link rel="prefetch" href="/blog/assets/js/53.f3610b84.js"><link rel="prefetch" href="/blog/assets/js/54.ed2d6c3b.js"><link rel="prefetch" href="/blog/assets/js/55.82ec5ba6.js"><link rel="prefetch" href="/blog/assets/js/56.05494772.js"><link rel="prefetch" href="/blog/assets/js/57.6c4d31de.js"><link rel="prefetch" href="/blog/assets/js/58.adaea99b.js"><link rel="prefetch" href="/blog/assets/js/59.8d7b110e.js"><link rel="prefetch" href="/blog/assets/js/6.075ad0d6.js"><link rel="prefetch" href="/blog/assets/js/60.a824ac80.js"><link rel="prefetch" href="/blog/assets/js/61.821778f8.js"><link rel="prefetch" href="/blog/assets/js/62.bd3049c3.js"><link rel="prefetch" href="/blog/assets/js/63.2abd2cf8.js"><link rel="prefetch" href="/blog/assets/js/64.25c1b6fa.js"><link rel="prefetch" href="/blog/assets/js/65.5862d6ed.js"><link rel="prefetch" href="/blog/assets/js/66.5e7b6293.js"><link rel="prefetch" href="/blog/assets/js/67.14f68b2e.js"><link rel="prefetch" href="/blog/assets/js/68.1bf58420.js"><link rel="prefetch" href="/blog/assets/js/69.ea9ae14c.js"><link rel="prefetch" href="/blog/assets/js/7.779683fb.js"><link rel="prefetch" href="/blog/assets/js/70.3da48032.js"><link rel="prefetch" href="/blog/assets/js/71.9fe04adc.js"><link rel="prefetch" href="/blog/assets/js/72.bcd62e5a.js"><link rel="prefetch" href="/blog/assets/js/73.10b3f3a9.js"><link rel="prefetch" href="/blog/assets/js/74.e2626435.js"><link rel="prefetch" href="/blog/assets/js/75.8d7fe3e1.js"><link rel="prefetch" href="/blog/assets/js/76.cd208881.js"><link rel="prefetch" href="/blog/assets/js/77.82b6e614.js"><link rel="prefetch" href="/blog/assets/js/78.50700c6c.js"><link rel="prefetch" href="/blog/assets/js/79.e230f5da.js"><link rel="prefetch" href="/blog/assets/js/8.242b22d8.js"><link rel="prefetch" href="/blog/assets/js/81.f8f1a9c8.js"><link rel="prefetch" href="/blog/assets/js/82.b6211fce.js"><link rel="prefetch" href="/blog/assets/js/83.6cabba5c.js"><link rel="prefetch" href="/blog/assets/js/84.a0dc3dfa.js"><link rel="prefetch" href="/blog/assets/js/85.b370face.js"><link rel="prefetch" href="/blog/assets/js/86.78137d90.js"><link rel="prefetch" href="/blog/assets/js/87.34e58bfd.js"><link rel="prefetch" href="/blog/assets/js/88.268a29b0.js"><link rel="prefetch" href="/blog/assets/js/9.6ee383ea.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.15804160.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><img src="/blog/assets/logo.png" alt="城南花已开" class="logo"> <span class="site-name can-hide">城南花已开</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="日常积累" class="dropdown-title"><span class="title">日常积累</span> <span class="arrow down"></span></button> <button type="button" aria-label="日常积累" class="mobile-dropdown-title"><span class="title">日常积累</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/daily-learn/JavaScript/call-apply-bind-simulator.html" class="nav-link">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/blog/daily-learn/vue/" class="nav-link">
  Vue
</a></li><li class="dropdown-item"><!----> <a href="/blog/daily-learn/CSS/make-talkbubble.html" class="nav-link">
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/blog/daily-learn/PHP/tp51-timestamp-autosave.html" class="nav-link">
  PHP
</a></li><li class="dropdown-item"><!----> <a href="/blog/daily-learn/Git/git-des.html" class="nav-link">
  Git
</a></li><li class="dropdown-item"><!----> <a href="/blog/daily-learn/Scaffold/Introduction.html" class="nav-link">
  Scaffold
</a></li><li class="dropdown-item"><!----> <a href="/blog/daily-learn/HandWriting/Promise.html" class="nav-link">
  HandWriting
</a></li><li class="dropdown-item"><!----> <a href="/blog/daily-learn/Node/Node-Koa1.html" class="nav-link">
  Node
</a></li></ul></div></div><div class="nav-item"><a href="/blog/cs-basic/data-structures/base-structures.html" class="nav-link">
  计算机基础
</a></div><div class="nav-item"><a href="/blog/translation/Arrays-symbols-and-realms.html" class="nav-link">
  外文翻译
</a></div> <a href="https://github.com/fengnzl" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="日常积累" class="dropdown-title"><span class="title">日常积累</span> <span class="arrow down"></span></button> <button type="button" aria-label="日常积累" class="mobile-dropdown-title"><span class="title">日常积累</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/daily-learn/JavaScript/call-apply-bind-simulator.html" class="nav-link">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/blog/daily-learn/vue/" class="nav-link">
  Vue
</a></li><li class="dropdown-item"><!----> <a href="/blog/daily-learn/CSS/make-talkbubble.html" class="nav-link">
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/blog/daily-learn/PHP/tp51-timestamp-autosave.html" class="nav-link">
  PHP
</a></li><li class="dropdown-item"><!----> <a href="/blog/daily-learn/Git/git-des.html" class="nav-link">
  Git
</a></li><li class="dropdown-item"><!----> <a href="/blog/daily-learn/Scaffold/Introduction.html" class="nav-link">
  Scaffold
</a></li><li class="dropdown-item"><!----> <a href="/blog/daily-learn/HandWriting/Promise.html" class="nav-link">
  HandWriting
</a></li><li class="dropdown-item"><!----> <a href="/blog/daily-learn/Node/Node-Koa1.html" class="nav-link">
  Node
</a></li></ul></div></div><div class="nav-item"><a href="/blog/cs-basic/data-structures/base-structures.html" class="nav-link">
  计算机基础
</a></div><div class="nav-item"><a href="/blog/translation/Arrays-symbols-and-realms.html" class="nav-link">
  外文翻译
</a></div> <a href="https://github.com/fengnzl" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>外文翻译</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/translation/Arrays-symbols-and-realms.html" class="sidebar-link">Arrays, symbols, and realms</a></li><li><a href="/blog/translation/A-Font-Like-SVG-Icon-System-for-Vue.html" class="sidebar-link">一个 Vue 的类似于 Font 的 SVG 图标系统</a></li><li><a href="/blog/translation/understanding-async-await.html" class="sidebar-link">理解 Async Await</a></li><li><a href="/blog/translation/write-js-by-six-letters.html" class="sidebar-link">仅用 6 个字符编写 JavaScript</a></li><li><a href="/blog/translation/JSON-parser-by-JS.html" class="sidebar-link">使用 JavaScript 编写 JSON 解析器</a></li><li><a href="/blog/translation/cors-fix.html" class="sidebar-link">修复 CORS 错误的三种方法及 Access-Control-Allow-Origin Header 的工作原理</a></li><li><a href="/blog/translation/setup-monorepo-with-PNPM-and-speed-it-up-with-Nx.html" aria-current="page" class="active sidebar-link">通过 PNPM workspaces 创建 Monorepo 并使用 Nx 加速！</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/translation/setup-monorepo-with-PNPM-and-speed-it-up-with-Nx.html#初始化一个新的-pnpm-workspaces" class="sidebar-link">初始化一个新的 PNPM workspaces</a></li><li class="sidebar-sub-header"><a href="/blog/translation/setup-monorepo-with-PNPM-and-speed-it-up-with-Nx.html#设置-monorepo-结构" class="sidebar-link">设置 Monorepo 结构</a></li><li class="sidebar-sub-header"><a href="/blog/translation/setup-monorepo-with-PNPM-and-speed-it-up-with-Nx.html#添加-remix-应用程序" class="sidebar-link">添加 Remix 应用程序</a></li><li class="sidebar-sub-header"><a href="/blog/translation/setup-monorepo-with-PNPM-and-speed-it-up-with-Nx.html#创建一个共享-ui-库" class="sidebar-link">创建一个共享 UI 库</a></li><li class="sidebar-sub-header"><a href="/blog/translation/setup-monorepo-with-PNPM-and-speed-it-up-with-Nx.html#在-remix-应用中使用我们的-shared-ui-包" class="sidebar-link">在 Remix 应用中使用我们的 shared-ui 包</a></li><li class="sidebar-sub-header"><a href="/blog/translation/setup-monorepo-with-PNPM-and-speed-it-up-with-Nx.html#通过-pnpm-运行命令" class="sidebar-link">通过 PNPM 运行命令</a></li><li class="sidebar-sub-header"><a href="/blog/translation/setup-monorepo-with-PNPM-and-speed-it-up-with-Nx.html#通过-nx-加速" class="sidebar-link">通过 Nx 加速</a></li><li class="sidebar-sub-header"><a href="/blog/translation/setup-monorepo-with-PNPM-and-speed-it-up-with-Nx.html#安装-nx" class="sidebar-link">安装 Nx</a></li><li class="sidebar-sub-header"><a href="/blog/translation/setup-monorepo-with-PNPM-and-speed-it-up-with-Nx.html#通过-nx-运行命令" class="sidebar-link">通过 Nx 运行命令</a></li><li class="sidebar-sub-header"><a href="/blog/translation/setup-monorepo-with-PNPM-and-speed-it-up-with-Nx.html#配置缓存" class="sidebar-link">配置缓存</a></li><li class="sidebar-sub-header"><a href="/blog/translation/setup-monorepo-with-PNPM-and-speed-it-up-with-Nx.html#精细调整缓存" class="sidebar-link">精细调整缓存</a></li><li class="sidebar-sub-header"><a href="/blog/translation/setup-monorepo-with-PNPM-and-speed-it-up-with-Nx.html#重用-globs-缓存输入" class="sidebar-link">重用 Globs 缓存输入</a></li><li class="sidebar-sub-header"><a href="/blog/translation/setup-monorepo-with-PNPM-and-speed-it-up-with-Nx.html#定义任务依赖-即构建流水线" class="sidebar-link">定义任务依赖（即构建流水线）</a></li><li class="sidebar-sub-header"><a href="/blog/translation/setup-monorepo-with-PNPM-and-speed-it-up-with-Nx.html#只有变化才运行" class="sidebar-link">只有变化才运行</a></li><li class="sidebar-sub-header"><a href="/blog/translation/setup-monorepo-with-PNPM-and-speed-it-up-with-Nx.html#额外功能" class="sidebar-link">额外功能</a></li><li class="sidebar-sub-header"><a href="/blog/translation/setup-monorepo-with-PNPM-and-speed-it-up-with-Nx.html#动态终端输出" class="sidebar-link">动态终端输出</a></li><li class="sidebar-sub-header"><a href="/blog/translation/setup-monorepo-with-PNPM-and-speed-it-up-with-Nx.html#项目图表可视化" class="sidebar-link">项目图表可视化</a></li><li class="sidebar-sub-header"><a href="/blog/translation/setup-monorepo-with-PNPM-and-speed-it-up-with-Nx.html#结论" class="sidebar-link">结论</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="通过-pnpm-workspaces-创建-monorepo-并使用-nx-加速"><a href="#通过-pnpm-workspaces-创建-monorepo-并使用-nx-加速" class="header-anchor">#</a> 通过 PNPM workspaces 创建 Monorepo 并使用 Nx 加速！</h1> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>* 原文：<a href="https://blog.nrwl.io/setup-a-monorepo-with-pnpm-workspaces-and-speed-it-up-with-nx-bc5d97258a7e" target="_blank" rel="noopener noreferrer">Setup a Monorepo with PNPM workspaces and speed it up with Nx!<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>* 作者：<a href="https://medium.com/@juristr" target="_blank" rel="noopener noreferrer">Juri Strumpflohner<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>* 翻译：<a href="https://fengnzl.github.io/" target="_blank" rel="noopener noreferrer">城南花已开<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <p>我们将学习如何使用PNPM运行命令,如何并行运行它们,最后我们将添加Nx以实现更复杂的任务调度</p> <p>在本篇文章，我们将深入谈到如何使用 <a href="https://pnpm.io/workspaces" target="_blank" rel="noopener noreferrer">PNPM workspaces<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 创建新的 monorepo， 该工作区包含一个 Remix 应用和一个基于 React 的库。我们将学习如何使用 PNPM 运行命令，如何并行运行它们，最后我们将添加 Nx 来实现更复杂的任务调度，包括命令缓存等等。</p> <p><strong>重要：</strong> 如果你已经对 PNPM workspaces 的创建和配置非常熟悉，请直接跳转到文章末尾 Nx 部分。</p> <p><strong>更喜欢实战视频？</strong></p> <iframe width="692" height="389" src="https://www.youtube.com/embed/ngdoUQBvAjo" title="Setup a monorepo with PNPM workspaces and add Nx for speed" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen="allowfullscreen"></iframe> <h2 id="初始化一个新的-pnpm-workspaces"><a href="#初始化一个新的-pnpm-workspaces" class="header-anchor">#</a> 初始化一个新的 PNPM workspaces</h2> <p>开始之前，请先确保你已安装了 PNPM。官方文档<a href="https://pnpm.io/installation" target="_blank" rel="noopener noreferrer">安装页面<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>有详细的说明。我同时也推荐使用类似 <a href="https://volta.sh/" target="_blank" rel="noopener noreferrer">Volta<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 的工具，特别是当你需要处理多个不同的 NPM/PNPM 和 node 版本的时候。</p> <p>让我们创建一个名为 <code>pnpm-mono</code> 的文件夹，cd 进入，然后运行 <code>pnpm init</code> 命令生成一个顶层的 <code>package.json</code> 文件。这将是我们 PNPM moonorepo 项目的 root <code>package.json</code>。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>❯ <span class="token function">mkdir</span> pnpm-mono
❯ <span class="token builtin class-name">cd</span> pnpm-mono
❯ <span class="token function">pnpm</span> init
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>初始化一个新的 Git 仓库也许会很方便，这样我们就可以在设置过程中提交和备份内容。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>❯ <span class="token function">git</span> init
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>现在，我们还需要创建一个 <code>.gitignore</code> 文件，从而立刻可以排除类似 <code>node_modules</code> 和通用构建输出文件夹等内容。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code># .gitignore
node_modules
dist
build
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="设置-monorepo-结构"><a href="#设置-monorepo-结构" class="header-anchor">#</a> 设置 Monorepo 结构</h2> <p>Monorepo 的结构通常与你打算使用它的目的而有所不同。以下是常用的两种目录结构：</p> <ul><li><strong>package centric</strong> 用于开发和发布一套可重复使用的软件包。这在开源世界中很常见的一种设置，可以在诸如 <a href="https://github.com/angular/angular" target="_blank" rel="noopener noreferrer">Angular<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，<a href="https://github.com/facebook/react" target="_blank" rel="noopener noreferrer">React<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，<a href="https://github.com/vuejs/vue" target="_blank" rel="noopener noreferrer">Vue<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 及其他许多仓库中可以看到。这些 repos 的特点是通常具有一个 <code>packages</code> 文件夹，并且通常会发布到类似 <a href="https://www.npmjs.com/" target="_blank" rel="noopener noreferrer">NPM<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 的公共注册中心。</li> <li><strong>app centric</strong> 主要用于开发应用程序和产品的仓库。这在公司中是一种常见的设置。这些 repos 的特点是拥有 <code>apps</code> 和 <code>packages</code> 或者 <code>libs</code> 文件夹，其中 <code>apps</code> 文件夹里面包括可构建和可部署的应用，而 <code>packages</code> 和 <code>libs</code> 文件夹包含特定于 monorepo 中正在开发的一个或者多个应用程序的库。你仍然可以将其中一些 libs 发布到公共注册中心。</li></ul> <p>在这篇文章，我们将使用 <code>app centric</code> 的方法，演示如何让应用程序从 monorepo 中使用 packages。</p> <p>在 <code>pnpm-mono</code> 文件夹中创建 <code>apps</code> 和 <code>packages</code> 文件夹：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>❯ <span class="token function">mkdir</span> apps packages
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>现在让我们来配置 PNPM 以正确识别 monorepo 工作区。基本上，我们需要在 repository 的根目录下创建一个 <code>pnpm-workspace.yaml</code> 文件，定义 monorepo 的结构：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment"># pnpm-workspace.yaml</span>
<span class="token key atrule">packages</span><span class="token punctuation">:</span>
  <span class="token comment"># executable/launchable applications</span>
  <span class="token punctuation">-</span> <span class="token string">'apps/*'</span>
  <span class="token comment"># all packages in subdirs of packages/ and components/</span>
  <span class="token punctuation">-</span> <span class="token string">'packages/*'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="添加-remix-应用程序"><a href="#添加-remix-应用程序" class="header-anchor">#</a> 添加 Remix 应用程序</h2> <p>现在我们已经完成了添加第一个应用的准备工作。我将选择 <a href="https://remix.run/" target="_blank" rel="noopener noreferrer">Remix<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 作为示例，但是你可以选择任意类型的应用，这并不重要：</p> <blockquote><p>提示： 我们将使用正常的 <a href="https://remix.run/docs/en/v1" target="_blank" rel="noopener noreferrer">Remix 安装和设置过程<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，你可以在它们的文档页面找到这些。</p></blockquote> <p>因为我们希望 app 在 <code>apps</code> 文件夹中，我们需要 <code>cd</code> 进入文件夹：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>❯ <span class="token builtin class-name">cd</span> apps
❯ npx create-remix@latest
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>你将会被要求输入应用名称。让我们使用 “my-remix-app”，我们将在这篇文章的后续部分用到它。显然，你可以取一个不同的名称。此外， Remix 设置过程会询问一些问题，以自定义确切的设置。这些特定选项与本文无关，所以您可以随意选择最适合您需求的选项。</p> <p>现在你拥有了一个 Remix 应用，在 <code>apps/my-remix-app</code> 文件夹下或者你自己选取的名称。Remix 已经有一个 <code>package.json</code> 文件以及相应的脚本配置：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;private&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token property">&quot;sideEffects&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;build&quot;</span><span class="token operator">:</span> <span class="token string">&quot;remix build&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;dev&quot;</span><span class="token operator">:</span> <span class="token string">&quot;remix dev&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token string">&quot;remix-serve build&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  ...
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>通常，在一个 monorepo 中你想在仓库的根目录下执行命令而不是在文件夹中不断切换。 PNPM 工作区已经有方法可以实现上述操作，只需要一个 <code>filter</code> 参数，例如：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>❯ <span class="token function">pnpm</span> --filter<span class="token punctuation">(</span>-F<span class="token punctuation">)</span> <span class="token operator">&lt;</span>package-name<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>command<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>现在（在本文的编写时），Remix 的默认 <code>pacakge.json</code> 文件中没有定义 PNPM 需要运行该包的 <code>name</code> 属性。因此，让我们在 <code>apps/my-remix-app/package.json</code> 文件中定义一个：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;my-remix-app&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;private&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token property">&quot;sideEffects&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  ...
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>你可以通过以下命令在 dev 模式下运行 Remix 应用服务：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>❯ <span class="token function">pnpm</span> <span class="token parameter variable">--filter</span> my-remix-app dev
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="https://raw.githubusercontent.com/fengnzl/HexoImages/master/blog/20221003181628.png" alt="remix-serve"></p> <h2 id="创建一个共享-ui-库"><a href="#创建一个共享-ui-库" class="header-anchor">#</a> 创建一个共享 UI 库</h2> <p>现在我们设置了我们的应用，让我们来创建一个可以被应用使用的 library package。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>❯ <span class="token builtin class-name">cd</span> packages
❯ <span class="token function">mkdir</span> shared-ui
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>下一步，让我们创建一个拥有以下内容的 <code>package.json</code> 文件（你也可以可以使用 <code>pnpm init</code> 创建，然后进行修改）：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;private&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;shared-ui&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Shared UI components&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;keywords&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;author&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;license&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ISC&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;dependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;devDependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>注意，我们声明它为 <code>private</code> 是因为我们不想将其发布到 NPM 或者其他地方，而只是在我们的工作区本地中进行引用和使用。我还删除了 <code>version</code> 属性，因为它没有被用到。</p> <p>作为技术栈，我选择使用 React(这样可以在 Remix 中使用) 和 Typescript(因为现今它被认为是标准)。让我们在工作区的根目录下安装这些依赖。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>❯ <span class="token function">pnpm</span> <span class="token parameter variable">--filter</span> shared-ui <span class="token function">add</span> react
❯ <span class="token function">pnpm</span> <span class="token parameter variable">--filter</span> shared-ui <span class="token function">add</span> typescript <span class="token parameter variable">-D</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>通过在安装命令中传入 <code>--filter shared-ui</code>，我们可以将这些 NPM 包本地安装到 <code>shared-ui</code> 库中。</p> <blockquote><p>提示：请注意这可能导致版本冲突如果我们库的 React/Typescript 版本与使用者（如我们的应用）的版本不同。采用<a href="https://opensource.google/documentation/reference/thirdparty/oneversion" target="_blank" rel="noopener noreferrer">单一版本策略<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，将包移动到 monorepo 的根目录，是一个可能的解决方案。</p></blockquote> <p>我们第一个组件是一个非常简单的 <code>Button</code> 组件。因此，我们来创建一个吧：</p> <div class="language-tsx line-numbers-mode"><pre class="language-tsx"><code><span class="token comment">// packages/shared-ui/Button.tsx</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">Button</span><span class="token punctuation">(</span>props<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> props<span class="token punctuation">.</span><span class="token function">onClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span>props<span class="token punctuation">.</span>children<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> Button<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>我们同样希望有一个公共 API，可以用来导出组件，以便在 <code>shared-ui</code> 外部使用。</p> <div class="language-tsx line-numbers-mode"><pre class="language-tsx"><code><span class="token comment">// packages/shared-ui/index.tsx</span>
<span class="token keyword">export</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">'./Button'</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>为了方便起见，我们只是使用 Typescript 编译器来编译我们的组件。我们可以使用一些更复杂的配置将多个文件打包在一起，如 Rollup 或者其他你使用的构建工具，但这超出了本文的范围。</p> <p>为了创建所需要的编译输出，我们需要创建 <code>packages/shared-ui/tsconfig.json</code> 文件并添加如下配置：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;compilerOptions&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;jsx&quot;</span><span class="token operator">:</span> <span class="token string">&quot;react-jsx&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;allowJs&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token property">&quot;esModuleInterop&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token property">&quot;allowSyntheticDefaultImports&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token property">&quot;module&quot;</span><span class="token operator">:</span> <span class="token string">&quot;commonjs&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;outDir&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./dist&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;include&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;.&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;exclude&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;dist&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;node_modules&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;**/*.spec.ts&quot;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><blockquote><p>在 monorepo 中，最好的做法是将公共配置抽离到更高一层的配置中（如根目录中），然后再各个项目中去扩展它。这是为了避免各种 monorepo 包中的大量重复。为了方便起见，我把它们都放在了一个地方。</p></blockquote> <p>正如你所见， <code>outDir</code> 指向本地包的 <code>dist</code> 文件夹。因此我们应该在 <code>shared-ui</code> 的 <code>package.json</code> 文件中添加主入口点。</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;private&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;shared-ui&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;main&quot;</span><span class="token operator">:</span> <span class="token string">&quot;dist/index.js&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>最后，实际的打包包括删除之前打包是创建的文件夹及执行 Typescript 编译器（tsc）。以下是 <code>packages/shared-ui/package.json</code> 完整文件。</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;private&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;shared-ui&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Shared UI components&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;main&quot;</span><span class="token operator">:</span> <span class="token string">&quot;dist/index.js&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;build&quot;</span><span class="token operator">:</span> <span class="token string">&quot;rm -rf dist &amp;&amp; tsc&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;keywords&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;author&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;license&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ISC&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;dependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;react&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^17.0.2&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;devDependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;typescript&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^4.6.4&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>在 PNPM 工作区的根目录下运行以下命令来执行打包：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>❯ <span class="token function">pnpm</span> <span class="token parameter variable">--filter</span> shared-ui build
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>如果构建成功，你会在 <code>packages/shared-ui/dist</code> 文件夹中看到编译的输出。</p> <h2 id="在-remix-应用中使用我们的-shared-ui-包"><a href="#在-remix-应用中使用我们的-shared-ui-包" class="header-anchor">#</a> 在 Remix 应用中使用我们的 shared-ui 包</h2> <p>我们的 <code>shared-ui</code> 库已经准备好了，因此我们可以在 <code>apps</code> 中的 Remix 应用中使用它。我们可以在 Remix 应用的 <code>package.json</code> 文件中手动添加依赖或者通过 PNPM 添加：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>❯ <span class="token function">pnpm</span> <span class="token parameter variable">--filter</span> my-remix-app <span class="token function">add</span> shared-ui <span class="token parameter variable">--workspace</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>这将会在 <code>apps/my-remix-app/package.json</code> 文件中添加依赖：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;my-remix-app&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;private&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token property">&quot;sideEffects&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  ...
  <span class="token property">&quot;dependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    ...
    <span class="token property">&quot;shared-ui&quot;</span><span class="token operator">:</span> <span class="token string">&quot;workspace:*&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  ...
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><code>workspace:*</code> 表明该包是在工作区本地进行解析的，而不是从一些远程注册中心（如 <a href="https://www.npmjs.com/" target="_blank" rel="noopener noreferrer">NPM<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）解析。<code>*</code> 简单的表示我们希望依赖于其最新版本，而不是特定的版本。如果你使用的是外部 NPM 包，那么使用特定的版本号是有意义的。</p> <p>为了使用 <code>Button</code> 组件，我们需要在 Remix 一些路由中导入。将 <code>apps/my-remix-app/app/routes/index.tsx</code> 中的内容替换如下：</p> <div class="language-tsx line-numbers-mode"><pre class="language-tsx"><code><span class="token comment">// apps/my-remix-app/app/routes/index.tsx</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Button <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'shared-ui'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">Index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Button</span></span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'clicked'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">Click me</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Button</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>现在如果你重新运行 Remix 应用，你将会看到 button 被渲染。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>❯ <span class="token function">pnpm</span> <span class="token parameter variable">--filter</span> my-remix-app dev
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>如果你遇到如下错误，说明你需要先构建 <code>shared-ui</code></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>Error: Cannot <span class="token function">find</span> module <span class="token string">'/Users/juri/nrwl/content/pnpm-demos/pnpm-mono/apps/my-remix-app/node_modules/shared-ui/dist/index.js'</span><span class="token builtin class-name">.</span> Please verify that the package.json has a valid <span class="token string">&quot;main&quot;</span> entry  
    at tryPackage <span class="token punctuation">(</span>node:internal/modules/cjs/loader:353:19<span class="token punctuation">)</span>  
    at Function.Module._findPath <span class="token punctuation">(</span>node:internal/modules/cjs/loader:566:18<span class="token punctuation">)</span>  
    at Function.Module._resolveFilename <span class="token punctuation">(</span>node:internal/modules/cjs/loader:919:27<span class="token punctuation">)</span>  
    at Function.Module._load <span class="token punctuation">(</span>node:internal/modules/cjs/loader:778:27<span class="token punctuation">)</span>  
    at Module.require <span class="token punctuation">(</span>node:internal/modules/cjs/loader:1005:19<span class="token punctuation">)</span>  
    at require <span class="token punctuation">(</span>node:internal/modules/cjs/helpers:102:18<span class="token punctuation">)</span>  
    at Object.<span class="token operator">&lt;</span>anonymous<span class="token operator">&gt;</span> <span class="token punctuation">(</span>/Users/juri/nrwl/content/pnpm-demos/pnpm-mono/apps/my-remix-app/app/routes/index.tsx:1:24<span class="token punctuation">)</span>  
    at Module._compile <span class="token punctuation">(</span>node:internal/modules/cjs/loader:1105:14<span class="token punctuation">)</span>  
    at Object.Module._extensions<span class="token punctuation">..</span>js <span class="token punctuation">(</span>node:internal/modules/cjs/loader:1159:10<span class="token punctuation">)</span>  
    at Module.load <span class="token punctuation">(</span>node:internal/modules/cjs/loader:981:32<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>要构建它，请运行</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>❯ <span class="token function">pnpm</span> <span class="token parameter variable">--filter</span> shared-ui build
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>为什么？这是因为引用和解析本地依赖 PNPM 创建的符号连接。通过在 Remix 应用的 <code>package.json</code> 文件中 添加 <code>shared-ui: &quot;workspace:*&quot;</code>，你指示 PNPM 将软连接添加到 Remix 的 <code>node_modules</code> 文件夹中。</p> <p><img src="https://raw.githubusercontent.com/fengnzl/HexoImages/master/blog/20221003200445.png" alt="symlink"></p> <h2 id="通过-pnpm-运行命令"><a href="#通过-pnpm-运行命令" class="header-anchor">#</a> 通过 PNPM 运行命令</h2> <p>PNPM 提供了一些方便的特性，在 monorepo 工作区中运行命令。我们已经看到如何通过 <code>--filter</code> 在特定的包上使用命令。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>❯ <span class="token function">pnpm</span> <span class="token parameter variable">--filter</span> my-remix-app dev
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>你同样可以通过 <code>-r</code> 标志在工作区中所有的包中递归运行一个命令。假如为所有的项目运行构建命令。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>❯ <span class="token function">pnpm</span> run <span class="token parameter variable">-r</span> build
Scope: <span class="token number">2</span> of <span class="token number">3</span> workspace projects
packages/shared-ui build$ <span class="token function">rm</span> <span class="token parameter variable">-rf</span> dist <span class="token operator">&amp;&amp;</span> tsc
└─ Done <span class="token keyword">in</span> 603ms
apps/my-remix-app build$ remix build
│ Building Remix app <span class="token keyword">in</span> production mode<span class="token punctuation">..</span>.
│ The path <span class="token string">&quot;shared-ui&quot;</span> is imported <span class="token keyword">in</span> app/routes/index.tsx but shared-ui is not listed <span class="token keyword">in</span> your package.json 
│ Built <span class="token keyword">in</span> 156ms
└─ Done <span class="token keyword">in</span> 547ms
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>类似的，你可以通过 <code>--parallel</code> 并行的运行命令</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>❯ <span class="token function">pnpm</span> run <span class="token parameter variable">--parallel</span> <span class="token parameter variable">-r</span> build
Scope: <span class="token number">2</span> of <span class="token number">3</span> workspace projects
apps/my-remix-app build$ remix build
packages/shared-ui build$ <span class="token function">rm</span> <span class="token parameter variable">-rf</span> dist <span class="token operator">&amp;&amp;</span> tsc
apps/my-remix-app build: Building Remix app <span class="token keyword">in</span> production mode<span class="token punctuation">..</span>.
apps/my-remix-app build: The path <span class="token string">&quot;shared-ui&quot;</span> is imported <span class="token keyword">in</span> app/routes/index.tsx but shared-ui is not listed <span class="token keyword">in</span> your package.json dependencies. Did you forget to <span class="token function">install</span> it?
apps/my-remix-app build: Built <span class="token keyword">in</span> 176ms
apps/my-remix-app build: Done
packages/shared-ui build: Done
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h2 id="通过-nx-加速"><a href="#通过-nx-加速" class="header-anchor">#</a> 通过 Nx 加速</h2> <p>PNPM 工作区提供了一些基本的功能，在 monorepo 包中运行任务，甚至是并行。随着 monorepo 的增长，你或许想要一个更加复杂的方法可以执行以下操作：</p> <ul><li>只有在包内容改变的时候才会运行任务</li> <li>根据文件内容的高级缓存，不运行之前已经计算过的任何内容</li> <li>远程分布式缓存以加速 CI</li></ul> <p>这正是 <a href="https://nx.dev/" target="_blank" rel="noopener noreferrer">Nx<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 可以提供帮助的地方。它针对 monorepo 场景进行了优化，并带有高级任务调度机制。我们仍然依赖 PNPM 提供的安装包和包链接机制，但是通过 Nx 来更加高效的运行我们的任务。</p> <h2 id="安装-nx"><a href="#安装-nx" class="header-anchor">#</a> 安装 Nx</h2> <p>由于 <a href="https://nx.dev/" target="_blank" rel="noopener noreferrer">Nx<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 将在整个 monorepo 工作区中运行操作，我们将其安装在根目录的 <code>package.json</code> 中。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>❯ <span class="token function">pnpm</span> <span class="token function">add</span> nx <span class="token parameter variable">-D</span> <span class="token parameter variable">-w</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>就这样。</p> <h2 id="通过-nx-运行命令"><a href="#通过-nx-运行命令" class="header-anchor">#</a> 通过 Nx 运行命令</h2> <p>Nx 通过以下形式运行你的命令：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>❯ npx nx <span class="token operator">&lt;</span>target<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>project<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><code>taget</code> 是特定情况下你想要执行的 NPM 脚本。
让我们试着运行以下命令来打包 <code>shared-ui</code> 包：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>❯ npx nx build shared-ui
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>这会产生以下输出</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token operator">&gt;</span> nx run shared-ui:build
<span class="token operator">&gt;</span> shared-ui@ build /Users/juri/nrwl/content/pnpm-demos/pnpm-mono/packages/shared-ui
<span class="token operator">&gt;</span> <span class="token function">rm</span> <span class="token parameter variable">-rf</span> dist <span class="token operator">&amp;&amp;</span> tsc
 <span class="token operator">&gt;</span>  NX   Successfully ran target build <span class="token keyword">for</span> project shared-ui <span class="token punctuation">(</span>1s<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>Nx 自动找到 <code>shared-ui</code> 并且执行 <code>packages/shared-ui/pacakge.json</code> 文件中定义的 <code>build</code> 脚本。</p> <p>类似的，要启动我们的 Remix 应用，运行 <code>npx nx dev my-remix-app</code>。</p> <p>我们同样可以在跨项目中并行执行命令：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>❯ npx nx run-many <span class="token parameter variable">--target</span><span class="token operator">=</span>build <span class="token parameter variable">--all</span>
    ✔  nx run my-remix-app:build <span class="token punctuation">(</span>1s<span class="token punctuation">)</span>
    ✔  nx run shared-ui:build <span class="token punctuation">(</span>1s<span class="token punctuation">)</span>
 <span class="token operator">&gt;</span>  NX   Successfully ran target build <span class="token keyword">for</span> <span class="token number">2</span> projects <span class="token punctuation">(</span>1s<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>或选择特定的项目</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>❯ npx nx run-many <span class="token parameter variable">--target</span><span class="token operator">=</span>build <span class="token parameter variable">--projects</span><span class="token operator">=</span>my-remix-app,shared-ui
    ✔  nx run my-remix-app:build <span class="token punctuation">(</span>1s<span class="token punctuation">)</span>
    ✔  nx run shared-ui:build <span class="token punctuation">(</span>1s<span class="token punctuation">)</span>
 <span class="token operator">&gt;</span>  NX   Successfully ran target build <span class="token keyword">for</span> <span class="token number">2</span> projects <span class="token punctuation">(</span>1s<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><blockquote><p>注意我用 <code>npx</code> 作为命令的前缀，该命令在 <code>node_modules</code> 文件夹中 Nx 可执行文件。这样我就不用全局安装 <code>nx</code>，如果你更喜欢全局方式，请随意。</p></blockquote> <h2 id="配置缓存"><a href="#配置缓存" class="header-anchor">#</a> 配置缓存</h2> <p>将 Nx 添加到 PNPM 工作区的一个主要好处是<strong>通过缓存提高速度</strong>。<a href="https://nx.dev/concepts/how-caching-works#computation-caching" target="_blank" rel="noopener noreferrer">计算缓存<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>是一种收集不同输入(源文件、环境变量、命令标志等)并计算哈希,将其存储在本地文件夹中的特性。当下一次你运行命令的时候，Nx 会寻找匹配的 hash，如果找到则恢复它。这包括恢复终端输出及构建制品（如 <code>dist</code> 文件夹中的 JS 文件）。</p> <p>并非所有操作都可以缓存,只有无副作用的操作可以缓存。例如，如果您运行具有相同输入的操作，它总是可靠的产生相同的输出。如果在执行的命令中调用了一些 API，那么它将无法缓存，因为给定相同的输入参数，API执行的结果可能会有所不同。</p> <p>为了开启缓存，让我们来配置可以缓存的操作。为此我们在工作区的根目录创建 <code>nx.json</code> 文件，并添加以下内容。</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token comment">// nx.json</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;tasksRunnerOptions&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;default&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;runner&quot;</span><span class="token operator">:</span> <span class="token string">&quot;nx/tasks-runners/default&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;options&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;cacheableOperations&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;build&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;test&quot;</span><span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>注意我们在 <code>cacheableOperations</code> 数组中指定了 <code>build</code> 和 <code>test</code>。你可以添加更多的操作如 <code>linting</code>。</p> <p>启用了这个，如果我们第一次运行 Remix 应用构建，那么可以看到跟往常一样，大概需要 1 秒钟。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>❯ npx nx build my-remix-app
<span class="token operator">&gt;</span> nx run my-remix-app:build
<span class="token operator">&gt;</span> my-remix-app@ build /Users/juri/nrwl/content/pnpm-demos/pnpm-mono/apps/my-remix-app
<span class="token operator">&gt;</span> remix build
Building Remix app <span class="token keyword">in</span> production mode<span class="token punctuation">..</span>.
The path <span class="token string">&quot;shared-ui&quot;</span> is imported <span class="token keyword">in</span> app/routes/index.tsx but shared-ui is not listed <span class="token keyword">in</span> your package.json dependencies. Did you forget to <span class="token function">install</span> it?
Built <span class="token keyword">in</span> 163ms
 <span class="token operator">&gt;</span>  NX   Successfully ran target build <span class="token keyword">for</span> project my-remix-app <span class="token punctuation">(</span>1s<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>如果你重新运行同样的命令，它现在将会从缓存中领取，并只需要几毫秒。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>❯ npx nx build my-remix-app
<span class="token operator">&gt;</span> nx run my-remix-app:build  <span class="token punctuation">[</span>existing outputs match the cache, left as is<span class="token punctuation">]</span>
<span class="token operator">&gt;</span> my-remix-app@ build /Users/juri/nrwl/content/pnpm-demos/pnpm-mono/apps/my-remix-app
<span class="token operator">&gt;</span> remix build
Building Remix app <span class="token keyword">in</span> production mode<span class="token punctuation">..</span>.
The path <span class="token string">&quot;shared-ui&quot;</span> is imported <span class="token keyword">in</span> app/routes/index.tsx but shared-ui is not listed <span class="token keyword">in</span> your package.json dependencies. Did you forget to <span class="token function">install</span> it?
Built <span class="token keyword">in</span> 163ms
 <span class="token operator">&gt;</span>  NX   Successfully ran target build <span class="token keyword">for</span> project my-remix-app <span class="token punctuation">(</span>9ms<span class="token punctuation">)</span>
Nx <span class="token builtin class-name">read</span> the output from the cache instead of running the <span class="token builtin class-name">command</span> <span class="token keyword">for</span> <span class="token number">1</span> out of <span class="token number">1</span> tasks.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>你可以在终端输出中看到如下提示 “existing outputs match the cache, left as is” 以及在末尾看到 “Nx read the output from the cache instead of running the command for 1 out of 1 tasks.”</p> <p>适当的缓存可以极大的提升命令的运行时间。如果缓存是远程分布的，它也可以与 CI 的其他开发任务人员机器共享，那么这也将变得更加有用。就 Nx 而言，可以通过 <a href="https://nx.dev/nx-cloud/set-up/set-up-caching" target="_blank" rel="noopener noreferrer">Nx Cloud<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 实现，他将每月免费（无需信用卡）可节省 500h/M 和开源项目的无限时间。</p> <h2 id="精细调整缓存"><a href="#精细调整缓存" class="header-anchor">#</a> 精细调整缓存</h2> <p>默认情况下，缓存机制将所有<a href="https://nx.dev/concepts/how-caching-works#source-code-hash-inputs" target="_blank" rel="noopener noreferrer">项目级文件作为输入<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。我们可能想要根据执行的目标来区分哪些文件正在被考虑。例如：如果只更改了单元测试的规范文件，你可能不希望使构建任务的缓存失效。</p> <p>为了在我们的示例中说明这一点，运行 <code>npx nx build my-remix-app</code> 两次，这样缓存就会被激活。下一步，改变 Remix 项目的 <code>READEME.md</code>（<code>apps/my-remix-app/READEME.md</code>） 文件。如果你再次构建 Remix 应用可以发现由于 README 文件的改动缓存失效了。这可能并不是期望的操作。</p> <p>我们可以精细调整缓存，通过在 <code>nx.json</code> 文件中添加 <code>targetDefaults</code> 节点，然后定义 <code>build</code> 目标默认 <code>input</code> 应该排除的 <code>*md</code> 文件。</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;tasksRunnerOptions&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;default&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;runner&quot;</span><span class="token operator">:</span> <span class="token string">&quot;nx/tasks-runners/default&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;options&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;cacheableOperations&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;build&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;test&quot;</span><span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;targetDefaults&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;build&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;inputs&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;!{projectRoot}/**/*.md&quot;</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>通过这个改动，MD 文件的变化将不会作为缓存输入的一部分，无论何时运行 <code>build</code> 任务。</p> <blockquote><p>注意所有路径的 globs 都相对于工作区的根目录而言。这样可以避免混淆，因为输入可以在 <code>packages.json</code>（<a href="https://nx.dev/reference/project-configuration" target="_blank" rel="noopener noreferrer">更多细节<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）中进行项目级别的定义。你可以通过插值变量 <code>{projectRoot}</code> 和 <code>{workspaceRoot}</code> 来区分路径是针对项目特定文件还是工作区级别的文件。</p></blockquote> <h2 id="重用-globs-缓存输入"><a href="#重用-globs-缓存输入" class="header-anchor">#</a> 重用 Globs 缓存输入</h2> <p>你还可以更进一步，你可以重用这个 glob 来排除一个假设 <code>test</code>目标中的 markdown 文件。你可以通过将 glob 提取到 <code>namedInputs</code> 属性来实现这点。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">{</span>
  <span class="token string">&quot;tasksRunnerOptions&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token punctuation">..</span>.
  <span class="token punctuation">}</span>,
  <span class="token string">&quot;namedInputs&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;noMarkdown&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">&quot;!{projectRoot}/**/*.md&quot;</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>,
  <span class="token string">&quot;targetDefaults&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;build&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;inputs&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">&quot;noMarkdown&quot;</span>, <span class="token string">&quot;^noMarkdown&quot;</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>,
    <span class="token string">&quot;test&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;inputs&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">&quot;noMarkdown&quot;</span>, <span class="token string">&quot;^noMarkdown&quot;</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>通过在 <code>namedInput</code> 前添加 <code>^</code> 表明这个改变同样应用于项目中的任何依赖的更改。</p> <h2 id="定义任务依赖-即构建流水线"><a href="#定义任务依赖-即构建流水线" class="header-anchor">#</a> 定义任务依赖（即构建流水线）</h2> <p>我们先前已经看到当运行 Remix 开发服务，但是在这之前没有编译依赖的 <code>shared-ui</code> 包，我们会在运行的时候得到以下错误：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>Error: Cannot <span class="token function">find</span> module <span class="token string">'/Users/juri/nrwl/content/pnpm-demos/pnpm-mono/apps/my-remix-app/node_modules/shared-ui/dist/index.js'</span><span class="token builtin class-name">.</span> Please verify that the package.json has a valid <span class="token string">&quot;main&quot;</span> entry  
    at tryPackage <span class="token punctuation">(</span>node:internal/modules/cjs/loader:353:19<span class="token punctuation">)</span>  
    at Function.Module._findPath <span class="token punctuation">(</span>node:internal/modules/cjs/loader:566:18<span class="token punctuation">)</span>  
    at Function.Module._resolveFilename <span class="token punctuation">(</span>node:internal/modules/cjs/loader:919:27<span class="token punctuation">)</span>  
    at Function.Module._load <span class="token punctuation">(</span>node:internal/modules/cjs/loader:778:27<span class="token punctuation">)</span>  
    at Module.require <span class="token punctuation">(</span>node:internal/modules/cjs/loader:1005:19<span class="token punctuation">)</span>  
    at require <span class="token punctuation">(</span>node:internal/modules/cjs/helpers:102:18<span class="token punctuation">)</span>  
    at Object.<span class="token operator">&lt;</span>anonymous<span class="token operator">&gt;</span> <span class="token punctuation">(</span>/Users/juri/nrwl/content/pnpm-demos/pnpm-mono/apps/my-remix-app/app/routes/index.tsx:1:24<span class="token punctuation">)</span>  
    at Module._compile <span class="token punctuation">(</span>node:internal/modules/cjs/loader:1105:14<span class="token punctuation">)</span>  
    at Object.Module._extensions<span class="token punctuation">..</span>js <span class="token punctuation">(</span>node:internal/modules/cjs/loader:1159:10<span class="token punctuation">)</span>  
    at Module.load <span class="token punctuation">(</span>node:internal/modules/cjs/loader:981:32<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>为了修复它，我们需要先手动构建 <code>shared-ui</code>。通常你希望避免如此操作，这就是 Nx 为什么定义了 <code>targetDefaults</code>（通常也称为“构建管道”） 的原因。</p> <p>作为第一个依赖项，我们希望定义当我们在一个项目进行目标构建时，构建目标所依赖的所有项目都应该先执行。我们可以在 <code>build</code> 任务定义处新增一个 <code>dependsOn</code> 属性。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">{</span>
  <span class="token string">&quot;tasksRunnerOptions&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token punctuation">..</span>.
  <span class="token punctuation">}</span>,
  <span class="token punctuation">..</span>.
  <span class="token string">&quot;targetDefaults&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;build&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token punctuation">..</span>.
      <span class="token string">&quot;dependsOn&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">&quot;^build&quot;</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>,
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>与我们在 <code>inputs</code> 的定义中看到的类似，这里的 <code>^</code> 表示目标应该在所有相关的项目上运行。如果删除 <code>^</code>，那么将在相同的项目上调用目标。如果您有一个总是需要调用 <code>prebuild</code> 步骤的项目，那么这将非常有用。</p> <p>下一步，我们同样希望对我们的 Remix <code>dev</code> 命令定义一个 targetDefault，就像 <code>build</code> 命令运行之前所有依赖的包（即 <code>shared-ui</code>）会运行。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">{</span>
  <span class="token string">&quot;tasksRunnerOptions&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token punctuation">..</span>.
  <span class="token punctuation">}</span>,
  <span class="token punctuation">..</span>.
  <span class="token string">&quot;targetDefaults&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;build&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token punctuation">..</span>.
      <span class="token string">&quot;dependsOn&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">&quot;^build&quot;</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>,
    <span class="token string">&quot;dev&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;dependsOn&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">&quot;^build&quot;</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>,
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>下面是完整的 <code>nx.json</code> 文件：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;tasksRunnerOptions&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;default&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;runner&quot;</span><span class="token operator">:</span> <span class="token string">&quot;nx/tasks-runners/default&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;options&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;cacheableOperations&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;build&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;test&quot;</span><span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;namedInputs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;noMarkdown&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;!{projectRoot}/**/*.md&quot;</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;targetDefaults&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;build&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;inputs&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;noMarkdown&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;^noMarkdown&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">&quot;dependsOn&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;^build&quot;</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;dev&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;dependsOn&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;^build&quot;</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>如果我们现在运行 <code>npx nx build my-remix-app</code>,我们可以看到 Nx 首先运行依赖项目上的任务,然后才运行我们调用的命令。</p> <p><img src="https://raw.githubusercontent.com/fengnzl/HexoImages/master/blog/20221003233123.png" alt="dependsOn"></p> <h2 id="只有变化才运行"><a href="#只有变化才运行" class="header-anchor">#</a> 只有变化才运行</h2> <p>除了提供缓存，Nx 同时也允许使用所谓的 “<a href="https://nx.dev/concepts/affected" target="_blank" rel="noopener noreferrer">affected command<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>“ 在给定的基准分之发生变化时执行。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>❯ npx nx affected:<span class="token operator">&lt;</span>target<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>你可以使用工作区中定义的任何目标。例如</p> <ul><li><code>npx nx affected:build</code></li> <li><code>npx nx affected:test</code></li> <li><code>npx nx affected:lint</code></li> <li><code>npx nx affected:publish</code></li></ul> <p><strong>这是如何运作的？</strong> Nx 基于 monorepo 工作区中包之间的结构和依赖关系构建了一个项目图，让我们假设是下面的图：</p> <p><img src="https://raw.githubusercontent.com/fengnzl/HexoImages/master/blog/20221003234925.png" alt="project-graph"></p> <p>当我们在某个分支运行 affected 命令，Nx 将所有的提交即相应的更改于基准分支进行比较。默认基准分支是 <code>main</code>，但是你可以在 <code>nx.json</code> 文件中进行设置：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">{</span>
  <span class="token string">&quot;affected&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;defaultBase&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;main&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>如果 <code>lib2</code> 在特性分支上发生了变化，在工作区运行测试命令 <code>affected:test</code>，那么只会运行 <code>lib2</code> 和 <code>appB</code> 上面的测试。</p> <p><img src="https://raw.githubusercontent.com/fengnzl/HexoImages/master/blog/20221003235400.png" alt="affected-test"></p> <p>但是要注意，如果我们运行 <code>affected:build</code> 命令，并且在 <code>nx.json</code> 中定义了一个依赖的项目需要首先构建(参见 “定义任务依赖” 部分)，那么 <code>affected:build</code> 命令将会构建：</p> <ul><li><code>lib3</code></li> <li><code>lib2</code></li> <li><code>appB</code></li></ul> <p>它将不会构建 <code>lib1</code> 和 <code>appA</code>。</p> <h2 id="额外功能"><a href="#额外功能" class="header-anchor">#</a> 额外功能</h2> <p>除了速度和任务调度方面的改进，我们还通过将 Nx 添加到 PNPM 工作区中获得了一些额外的功能。让我们来探索一下。</p> <h2 id="动态终端输出"><a href="#动态终端输出" class="header-anchor">#</a> 动态终端输出</h2> <p>PNPM 并行运行任务会导致相当混乱的终端输出。日志很难解析，因为并行执行的不同命令的消息是交错的。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>❯ <span class="token function">pnpm</span> run <span class="token parameter variable">--parallel</span> <span class="token parameter variable">-r</span> build
Scope: <span class="token number">2</span> of <span class="token number">3</span> workspace projects
apps/my-remix-app build$ remix build
packages/shared-ui build$ <span class="token function">rm</span> <span class="token parameter variable">-rf</span> dist <span class="token operator">&amp;&amp;</span> tsc
apps/my-remix-app build: Building Remix app <span class="token keyword">in</span> production mode<span class="token punctuation">..</span>.
apps/my-remix-app build: The path <span class="token string">&quot;shared-ui&quot;</span> is imported <span class="token keyword">in</span> app/routes/index.tsx but shared-ui is not listed <span class="token keyword">in</span> your package.json dependencies. Did you forget to <span class="token function">install</span> it?
apps/my-remix-app build: Built <span class="token keyword">in</span> 176ms
apps/my-remix-app build: Done
packages/shared-ui build: Done
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>当使用 Nx 运行任务时,你会得到一个动态终端,它只显示必要的和与当前执行的命令最相关的内容。在使用 Nx 时,运行相同的并行构建任务会得到以下输出：</p> <p><img src="https://miro.medium.com/max/1400/1*GbaJL87ZfOpBQm-W6lBheQ.gif" alt="build-parallel"></p> <h2 id="项目图表可视化"><a href="#项目图表可视化" class="header-anchor">#</a> 项目图表可视化</h2> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>❯ npx nx graph
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>这加载了工作区的项目图的可视化交互，具有一些高级过滤，调试工作区结构等高级功能</p> <p><img src="https://raw.githubusercontent.com/fengnzl/HexoImages/master/blog/20221004001155.png" alt="project-graph"></p> <blockquote><p>作为旁注：你可以在任意的 PNPM 工作区运行项目图表，即使你没有安装 Nx，运行 <code>npx nx graph</code> 应该会起作用。</p></blockquote> <h2 id="结论"><a href="#结论" class="header-anchor">#</a> 结论</h2> <p>我们做到了！下面是我们所覆盖到的一些知识：</p> <ul><li>如何基于 monorepo 工作区设置 PNPM</li> <li>在 PNPM monorepo 中创建一个 Remix 应用和 React 库</li> <li>如何运行不同的 PNPM 命令</li> <li>如何添加 Nx 并在 monorepo 中逐步使用</li> <li>在 PNPM monorepo 中添加 Nx 的好处及功能</li></ul> <p>你可以在 <a href="https://github.com/nrwl/nx-recipes/tree/main/pnpm-workspace" target="_blank" rel="noopener noreferrer">Nx Recipe GitHub<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 仓库中找到上述设置的例子。</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/fengnzl/vuepress-blog/edit/master/docs/translation/setup-monorepo-with-PNPM-and-speed-it-up-with-Nx.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">12/10/2022, 4:19:06 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/translation/cors-fix.html" class="prev">
        修复 CORS 错误的三种方法及 Access-Control-Allow-Origin Header 的工作原理
      </a></span> <!----></p></div> </main></div><div class="global-ui"><!----><div></div></div></div>
    <script src="/blog/assets/js/app.2cc39ea3.js" defer></script><script src="/blog/assets/js/2.fb25410d.js" defer></script><script src="/blog/assets/js/80.63dd0422.js" defer></script>
  </body>
</html>
